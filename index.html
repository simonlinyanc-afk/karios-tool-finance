<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yellow Bird Finance Â· Kairos</title>

  <!-- Google Fonts: Source Han Sans (æ€æºé»‘ä½“) & Plus Jakarta Sans -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">

  <!-- React & Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <!-- html2pdf.js for PDF generation with Chinese support -->
  <script src="/libs/html2pdf.bundle.min.js"></script>

  <!-- PDF.js for PDF to Image conversion -->
  <script src="/libs/pdf.min.js"></script>
  <script>
    // Configure PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = '/libs/pdf.worker.min.js';
  </script>

  <!-- ExcelJS for Excel Export with Image Support -->
  <script src="/libs/exceljs.min.js"></script>

  <!-- Local Storage (Dexie.js) -->
  <script src="https://unpkg.com/dexie/dist/dexie.js"></script>

  <!-- Global Utilities (Must be loaded after libraries) -->
  <script src="js/utils/finance.js"></script>
  <script src="js/utils/exportManager.js"></script>
  <script src="js/utils/storageRepository.js"></script>
  <script type="text/babel" src="js/components/icons.js"></script>
  <script type="text/babel" src="js/components/ReimbursementTable.js"></script>
  <script type="text/babel" src="js/components/HistorySidebar.js"></script>

  <!-- External Stylesheet -->
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Access global Icons (loaded from icons.js)
    const {
      Icon, Upload, FileText, Settings, Eye, User, Briefcase, Calendar, Download, X, ChevronDown, ChevronUp, Plus, Image, RefreshCw, Clock, Trash2
    } = window;

    // Yellow Bird Finance Logo as inline SVG
    const LogoSVG = () => React.createElement('svg', {
      width: '160',
      height: '24',
      viewBox: '0 0 300 53',
      fill: 'none',
      className: 'h-6',
      xmlns: 'http://www.w3.org/2000/svg'
    },
      React.createElement('text', {
        x: '0',
        y: '40',
        fill: '#FFFFFF',
        fontSize: '36',
        fontFamily: 'Noto Sans SC, sans-serif',
        fontWeight: '500'
      }, 'é»„é¸Ÿè´¢åŠ¡åŠ©æ‰‹')
    );

    const App = () => {
      const { Plus, Trash2, FileText, Upload, Settings, X, ChevronDown, ChevronUp, Download, Eye, Image, User, Calendar, RefreshCw, Check, Briefcase } = window;
      // State
      const [items, setItems] = useState([]);
      const [isDragging, setIsDragging] = useState(false);
      const [isProcessing, setIsProcessing] = useState(false);
      const [pdfPreviewUrl, setPdfPreviewUrl] = useState(null);
      const [ocrConfirmation, setOcrConfirmation] = useState({
        show: false,
        itemId: null,
        file: null,
        imageUrl: null
      });
      const [processingQueue, setProcessingQueue] = useState([]);
      const [expandedRows, setExpandedRows] = useState(new Set());

      const [reimbursementInfo, setReimbursementInfo] = useState({
        reimburser: '',
        project: '',
        reimbursementDate: new Date().toISOString().split('T')[0],
        reimbursementDate: new Date().toISOString().split('T')[0],
        paymentInfo: ''
      });

      const [exportProgress, setExportProgress] = useState({
        show: false,
        processed: 0,
        total: 0,
        message: ''
      });

      const [showTutorial, setShowTutorial] = useState(() => {
        return !localStorage.getItem('tutorialCompleted');
      });

      const [pdfItems, setPdfItems] = useState(null);

      const closeTutorial = () => {
        localStorage.setItem('tutorialCompleted', 'true');
        setShowTutorial(false);
      };

      // Auto-cleanup old history on mount
      useEffect(() => {
        if (window.storageRepo && window.storageRepo.autoCleanup30Days) {
          window.storageRepo.autoCleanup30Days();
        }
      }, []);

      // Initial Columns Definition
      const initialColumns = [
        { id: 'preview', label: 'å‘ç¥¨å›¾', visible: true, fixed: true, width: 'w-20' },
        { id: 'orderImage', label: 'è®¢å•å›¾', visible: true, width: 'w-20' },
        { id: 'paymentProof', label: 'æ”¯ä»˜å‡­è¯/é™„ä»¶', visible: true, width: 'w-20' },
        { id: 'date', label: 'æ—¥æœŸ', visible: true, width: 'w-32' },
        { id: 'category', label: 'ç±»åˆ«', visible: true, width: 'w-24' },
        { id: 'description', label: 'æè¿°', visible: true, width: 'w-48' },
        { id: 'subtotal', label: 'é‡‘é¢ï¼ˆç¨å‰ï¼‰', visible: false, width: 'w-32' },
        { id: 'taxRate', label: 'ç¨ç‡', visible: false, width: 'w-20' },
        { id: 'tax', label: 'ç¨é¢', visible: false, width: 'w-24' },
        { id: 'amount', label: 'é‡‘é¢ï¼ˆç¨åï¼‰', visible: true, width: 'w-32' },
        { id: 'invoiceNumber', label: 'å‘ç¥¨å·ç ', visible: false, width: 'w-36' },
        { id: 'buyerName', label: 'è´­ä¹°æ–¹', visible: false, width: 'w-48' },

        { id: 'sellerName', label: 'é”€å”®æ–¹', visible: false, width: 'w-48' },
        { id: 'itemName', label: 'é¡¹ç›®åç§°', visible: false, width: 'w-48' },
        { id: 'specification', label: 'è§„æ ¼å‹å·', visible: false, width: 'w-32' },
        { id: 'quantity', label: 'æ•°é‡', visible: false, width: 'w-24' },
        { id: 'unit', label: 'å•ä½', visible: false, width: 'w-20' },
        { id: 'unitPrice', label: 'å•ä»·', visible: false, width: 'w-28' },
        { id: 'actions', label: 'æ“ä½œ', visible: true, fixed: true, width: 'w-24' },
      ];

      const [columns, setColumns] = useState(initialColumns);
      const [showColumnManager, setShowColumnManager] = useState(false);
      const [showExportPreview, setShowExportPreview] = useState(false);
      const [showHistory, setShowHistory] = useState(false);
      const [showDraftPrompt, setShowDraftPrompt] = useState(false);
      const [draftData, setDraftData] = useState(null);
      const [previewTab, setPreviewTab] = useState('excel'); // 'excel' or 'pdf'

      // v1.1.0 States
      const [autoSaveEnabled, setAutoSaveEnabled] = useState(true);
      const [saveStatus, setSaveStatus] = useState('ready'); // 'ready', 'saving'
      const [showCloseDialog, setShowCloseDialog] = useState(false);
      const [showToast, setShowToast] = useState(false); // v1.1.0 Toast State

      // Auto-save Draft (v1.1.0 Enhanced)
      useEffect(() => {
        if (!autoSaveEnabled) return;

        setSaveStatus('saving');
        const saveTimer = setTimeout(async () => {
          if (window.storageRepo && window.storageRepo.saveCurrentDraft) {
            await window.storageRepo.saveCurrentDraft(items, reimbursementInfo);
            setSaveStatus('ready');
          }
        }, 2000); // Debounce 2s
        return () => clearTimeout(saveTimer);
      }, [items, reimbursementInfo, autoSaveEnabled]);

      // Check for existing draft on mount
      useEffect(() => {
        const checkDraft = async () => {
          if (window.storageRepo && window.storageRepo.getLatestDraft) {
            const draft = await window.storageRepo.getLatestDraft();
            if (draft && draft.items && draft.items.length > 0) {
              setDraftData(draft);
              setShowDraftPrompt(true);
            }
          }
        };
        checkDraft();
      }, []);

      const handleRestoreDraft = () => {
        if (draftData) {
          setItems(draftData.items || []);
          setReimbursementInfo(draftData.info || {});
          setShowDraftPrompt(false);
        }
      };

      const handleDiscardDraft = async () => {
        if (window.storageRepo && window.storageRepo.deleteDraft) {
          await window.storageRepo.deleteDraft();
        }
        setShowDraftPrompt(false);
        setDraftData(null);
      };

      // v1.1.0 Project Actions
      const handleSaveProject = async () => {
        if (!items.length && !reimbursementInfo.project) {
          alert('æ— å¯ä¿å­˜å†…å®¹');
          return;
        }
        setSaveStatus('saving');
        if (window.storageRepo && window.storageRepo.archiveToHistory) {
          // Pass columns as 3rd arg
          await window.storageRepo.archiveToHistory(items, reimbursementInfo, columns);

          // Show Success Toast
          setSaveStatus('ready');
          setShowToast(true);
          setTimeout(() => setShowToast(false), 3000);
        } else {
          setSaveStatus('ready');
        }
      };

      const handleCleanProject = () => {
        // Check if critical info is missing
        if (!items.length && !reimbursementInfo.project && !reimbursementInfo.reimburser) {
          // If completely empty, just reset (no op really, but good to be sure)
          resetWorkspace();
          return;
        }

        if (!reimbursementInfo.project || !reimbursementInfo.reimburser) {
          setShowCloseDialog(true);
        } else {
          // Check if saved? Or just ask confirmation?
          // User asked for "Clean" logic.
          // Let's pop the dialog if there's any data, to be safe?
          // Or stick to previous logic: Pop if incomplete.
          // User: "Close -> Clean, logic changed to clear all contents".
          // If I interpret "clear all content" as the PRIMARY action, maybe just do it?
          // But I'll keep the dialog as a safety net.
          // Let's trust the previous pattern but rename.
          resetWorkspace();
        }
      };

      const resetWorkspace = async () => {
        setItems([]);
        setReimbursementInfo({ reimburser: '', project: '', reimbursementDate: '', paymentInfo: '' });
        if (window.storageRepo && window.storageRepo.deleteDraft) {
          await window.storageRepo.deleteDraft();
        }
      };

      // Convert PDF to Image using PDF.js
      // Logic moved to utils.js (convertPDFToImage)


      // File Upload Handler
      const handleFiles = async (files) => {
        setIsProcessing(true);
        const newItems = [];
        const filesArray = Array.from(files);

        // ... processing logic ...
        // Simplified for brevity, reusing logic but mapping new fields
        const queue = filesArray.map((file, index) => ({
          id: Date.now() + index,
          name: file.name,
          status: 'waiting',
          progress: 0
        }));
        setProcessingQueue(queue);

        for (let i = 0; i < filesArray.length; i++) {
          const file = filesArray[i];
          const queueItem = queue[i];
          const isPDF = file.type === "application/pdf" || file.name.toLowerCase().endsWith(".pdf");

          setProcessingQueue(prev => prev.map(item =>
            item.id === queueItem.id ? { ...item, status: 'processing', progress: 50 } : item
          ));

          try {
            // If it's a PDF, convert to image first
            let fileToProcess = file;
            let convertedImageUrl = null;

            if (isPDF) {
              const convertedFile = await convertPDFToImage(file);
              if (convertedFile) {
                fileToProcess = convertedFile;
                convertedImageUrl = URL.createObjectURL(convertedFile);
              }
            }

            // Convert image to base64
            const reader = new FileReader();
            const imageBase64 = await new Promise((resolve, reject) => {
              reader.onload = () => resolve(reader.result);
              reader.onerror = reject;
              reader.readAsDataURL(fileToProcess);
            });

            // Call serverless OCR function
            const response = await fetch('/api/ocr', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                image: imageBase64
              })
            });

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            // Use processing logic from utils.js
            const newItem = processOCRResponse(data, file, isPDF, convertedImageUrl, reimbursementInfo, i);
            newItems.push(newItem);

            setProcessingQueue(prev => prev.map(item =>
              item.id === queueItem.id ? { ...item, status: 'completed', progress: 100 } : item
            ));

          } catch (error) {
            console.error(`Error processing ${file.name}:`, error);
            setProcessingQueue(prev => prev.map(item =>
              item.id === queueItem.id ? { ...item, status: 'failed', progress: 100 } : item
            ));

            // Use failure logic from utils.js
            newItems.push(createFailedItem(file, isPDF, error, reimbursementInfo, i));
          }
        }

        // Remove default row (id: 1) if it exists and is empty
        const filteredItems = items.filter(item => {
          if (item.id === 1 && !item.date && !item.description && item.amount === 0) {
            return false; // Remove default empty row
          }
          return true;
        });

        setItems([...filteredItems, ...newItems]);
        setIsProcessing(false);
        setTimeout(() => setProcessingQueue([]), 3000);
      };

      // Drag & Drop
      const onDragOver = (e) => { e.preventDefault(); setIsDragging(true); };
      const onDragLeave = () => setIsDragging(false);
      const onDrop = (e) => {
        e.preventDefault();
        setIsDragging(false);
        handleFiles(e.dataTransfer.files);
      };

      // Update Item with Advanced Financial Logic
      const updateItem = (id, field, value) => {
        setItems(prevItems => prevItems.map(item => {
          if (item.id !== id) return item;
          return calculateTax(item, field, value);
        }));
      };

      // Handle Image Upload
      const handleImageUpload = (id, field, file) => {
        if (!file) return;
        const url = URL.createObjectURL(file);
        updateItem(id, field, url);
      };

      // Delete Item
      const deleteItem = (id) => {
        setItems(items.filter(item => item.id !== id));
      };


      // Toggle Row Expansion
      const toggleRow = (id) => {
        const newExpanded = new Set(expandedRows);
        if (newExpanded.has(id)) {
          newExpanded.delete(id);
        } else {
          newExpanded.add(id);
        }
        setExpandedRows(newExpanded);
      };


      // Convert blob URL to base64 for ExcelJS
      // Logic moved to utils.js (blobToBase64)


      // Export to Excel with Images using ExcelJS
      const exportExcel = async () => {
        try {
          if (typeof ExcelJS === 'undefined') {
            alert('Excel å¯¼å‡ºåº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
            return;
          }

          const workbook = new ExcelJS.Workbook();
          const worksheet = workbook.addWorksheet('æŠ¥é”€å•');

          // Get visible columns (excluding actions)
          const visibleCols = columns.filter(c => c.visible && c.id !== 'actions');

          // Add column header row (row 1)
          worksheet.addRow(visibleCols.map(c => c.label));
          worksheet.getRow(1).font = { bold: true };
          worksheet.getRow(1).fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFE3E0D1' }
          };

          // Export with progress callback
          setExportProgress({ show: true, processed: 0, total: 0, message: 'å‡†å¤‡å¼€å§‹å¯¼å‡º...' });

          await window.exportToExcel(items, visibleCols, reimbursementInfo, (progress) => {
            setExportProgress({
              show: true,
              ...progress
            });
          });

          // Brief delay before closing to show completion
          setTimeout(() => {
            setExportProgress(prev => ({ ...prev, show: false }));
          }, 1500);

        } catch (error) {
          console.error('Excel export failed:', error);
          alert('Excel å¯¼å‡ºå¤±è´¥: ' + error.message);
          setExportProgress(prev => ({ ...prev, show: false }));
        }
      };


      // Helper to compress images for PDF export - ROBUST BASE64 VERSION
      // Logic moved to utils.js (resizeImage)


      const exportPDF = async () => {
        try {
          if (typeof html2pdf === 'undefined') {
            alert('PDF å¯¼å‡ºåº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
            return;
          }

          setIsProcessing(true);

          // 1. Optimize images specifically for PDF export
          const optimizedItems = await Promise.all(items.map(async (item) => {
            const newItem = { ...item };

            // Compress all image fields
            const imageFields = ['previewUrl', 'orderImage', 'paymentProof'];
            for (const field of imageFields) {
              if (newItem[field] || (field === 'preview' && newItem.previewUrl)) {
                const src = newItem[field] || newItem.previewUrl;
                if (src && src.startsWith('blob:')) {
                  newItem[field] = await resizeImage(src);
                }
              }
            }
            return newItem;
          }));

          setPdfItems(optimizedItems);

          // Give React time to render the optimized items into the hidden DOM
          await new Promise(resolve => setTimeout(resolve, 800));

          // Get the PDF preview element
          const element = document.getElementById('pdf-preview-content');
          if (!element) {
            alert('PDF é¢„è§ˆå†…å®¹æœªæ‰¾åˆ°');
            setIsProcessing(false);
            return;
          }

          // Configure pdf options - optimized for speed
          const opt = {
            margin: 5,
            filename: `æŠ¥é”€å•_${reimbursementInfo.reimburser || 'Export'}_${new Date().toISOString().split('T')[0]}.pdf`,
            image: { type: 'jpeg', quality: 0.90 },
            html2canvas: {
              scale: 1.5,
              useCORS: true,
              allowTaint: true,
              logging: false
            },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
          };

          // Generate and download PDF
          console.log('Starting html2pdf generation...');
          await html2pdf().set(opt).from(element).save();
          console.log('html2pdf finished');

        } catch (error) {
          console.error('PDF export failed:', error);
          alert('PDF å¯¼å‡ºå¤±è´¥: ' + error.message);
        } finally {
          console.log('Export process finished (finally block)');
          setIsProcessing(false);
          setPdfItems(null); // Clear optimized items to free memory
        }
      };

      // NEW: Browser-native print export (uses print.html)
      const exportPDF_Print = () => {
        try {
          console.log('ğŸ–¨ï¸ Preparing print export...');

          // Prepare export data
          const exportData = {
            items: items,
            reimbursementInfo: reimbursementInfo,
            columns: columns.filter(c => c.visible && c.id !== 'actions'),
            timestamp: Date.now()
          };

          // Store in localStorage
          localStorage.setItem('printData', JSON.stringify(exportData));
          console.log('âœ… Data stored in localStorage');

          // Open print window
          const printWindow = window.open('print.html', '_blank', 'width=1200,height=800');

          if (!printWindow) {
            alert('æ— æ³•æ‰“å¼€æ‰“å°çª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å¼¹çª—è®¾ç½®');
            return;
          }

          console.log('âœ… Print window opened');

        } catch (error) {
          console.error('âŒ Print export failed:', error);
          alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
        }
      };





      const addNewRow = () => {
        const newItem = {
          id: Date.now(),
          file: null,
          isPDF: false,
          previewUrl: null,
          date: new Date().toISOString().split('T')[0],
          amount: 0,
          tax: 0,
          category: "å…¶ä»–",
          description: "",
          itemName: "",
          specification: "",
          unit: "",
          quantity: 0,
          unitPrice: 0,
          taxRate: "",
          subtotal: 0,
          totalWithTax: 0,
          invoiceNumber: "",
          buyerName: "",
          sellerName: "",
          attachments: [],
          remarks: "",
          reimburser: reimbursementInfo.reimburser || "",
          project: reimbursementInfo.project || ""
        };
        setItems([...items, newItem]);
      };

      // Use amount for total calculation
      const totalAmount = items.reduce((sum, item) => sum + Number(item.amount || 0), 0);

      // Reusable PDF Content Component
      const PDFContent = ({ items, reimbursementInfo, columns }) => {
        // Use 'amount' for total calculation to match visible column
        const pdfTotalAmount = items.reduce((sum, item) => sum + Number(item.amount || 0), 0);
        // Filter columns based on visibility toggle (respect the 'visible' property)
        const visibleColumns = columns.filter(c => c.visible && c.id !== 'actions');

        // Use 275mm width to ensure it fits within A4 Landscape (297mm) minus margins
        return (
          <div id="pdf-preview-content" className="p-4 bg-white text-black w-[275mm] min-h-[210mm] mx-auto text-[9px] relative">
            <div className="flex items-center justify-between mb-3">
              <img src="assets/logo_text.png" alt="Kairos Studio Logo" className="h-8" />
              <h1 className="text-lg font-bold flex-1 text-center">æŠ¥é”€å•</h1>
              <img src="assets/logo_graph.png" alt="Kairos Graph Logo" className="h-8" />
            </div>

            <div className="mb-2 grid grid-cols-3 gap-2 text-[10px]">
              <p><strong>æŠ¥é”€äºº:</strong> {reimbursementInfo.reimburser || 'æœªå¡«å†™'}</p>
              <p><strong>æ‰€å±é¡¹ç›®:</strong> {reimbursementInfo.project || 'æœªå¡«å†™'}</p>
              <p><strong>æŠ¥é”€æ—¥æœŸ:</strong> {reimbursementInfo.reimbursementDate || new Date().toLocaleDateString('zh-CN')}</p>
            </div>
            <div className="mb-2 text-[10px]">
              <p><strong>æ”¶æ¬¾ä¿¡æ¯:</strong> {reimbursementInfo.paymentInfo || 'æœªå¡«å†™'}</p>
            </div>

            <table className="w-full border-collapse mb-2 table-auto">
              <thead>
                <tr>
                  {visibleColumns.map(col => (
                    <th key={col.id} className="border border-gray-400 p-1 text-left bg-gray-100">{col.label}</th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {items.map(item => (
                  <tr key={item.id}>
                    {visibleColumns.map(col => (
                      <td key={col.id} className="border border-gray-400 p-1">
                        {(() => {
                          if (['preview', 'orderImage', 'paymentProof'].includes(col.id)) {
                            let url = null;
                            if (col.id === 'preview') url = item.previewUrl || item.preview;
                            else if (col.id === 'orderImage') url = item.orderImageUrl || item.orderImage;
                            else if (col.id === 'paymentProof') url = item.paymentProofUrl || item.paymentProof;
                            else url = item[col.id];

                            return url ? (
                              <img src={url} className="w-16 h-16 object-contain mx-auto" alt={col.label} />
                            ) : null;
                          }

                          // Non-image columns
                          if (['amount', 'subtotal', 'totalWithTax', 'tax', 'unitPrice'].includes(col.id)) {
                            return `Â¥${formatCurrency(item[col.id])}`;
                          }
                          return item[col.id] || '';
                        })()}
                      </td>
                    ))}
                  </tr>
                ))}
              </tbody>
              <tfoot>
                <tr>
                  <td colSpan={visibleColumns.length - 1} className="border border-gray-400 p-1 text-right font-bold bg-gray-50">
                    æ€»è®¡:</td>
                  <td className="border border-gray-400 p-1 text-right font-bold bg-gray-50">Â¥{formatCurrency(pdfTotalAmount)}</td>
                </tr>
              </tfoot>
            </table>

            <div className="text-xs mt-6">
              <p><strong>å¤‡æ³¨:</strong></p>
              <p className="min-h-[30px] border-b border-gray-300"></p>
            </div>

            <div className="flex justify-between mt-8 text-xs">
              <p><strong>æŠ¥é”€äººç­¾å­—:</strong> <span className="min-w-[100px] inline-block border-b border-gray-300"></span></p>
              <p><strong>å®¡æ ¸äººç­¾å­—:</strong> <span className="min-w-[100px] inline-block border-b border-gray-300"></span></p>
            </div>
          </div>
        );
      };

      // Main App return
      return (
        <div className="min-h-screen bg-gradient-to-br from-[#0a0a0a] via-[#1a1a1a] to-[#0a0a0a]">

          {/* Swiss-style Progress Modal */}
          {exportProgress.show && (
            <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm transition-all duration-300">
              <div className="bg-white text-black p-8 rounded-none w-full max-w-sm shadow-2xl relative overflow-hidden animate-fade-in border-l-4 border-yellow-500">
                <h3 className="text-2xl font-bold font-cn mb-1 tracking-tight">æ­£åœ¨å¯¼å‡º</h3>
                <p className="text-xs text-gray-500 font-en uppercase tracking-widest mb-6">Processing Request</p>

                <div className="mb-4">
                  <div className="flex justify-between text-xs font-bold mb-2">
                    <span>{exportProgress.message}</span>
                    <span>{exportProgress.total > 0 ? Math.round((exportProgress.processed / exportProgress.total) * 100) : 0}%</span>
                  </div>
                  <div className="h-1 w-full bg-gray-100 overflow-hidden">
                    <div
                      className="h-full bg-yellow-500 transition-all duration-300 ease-out"
                      style={{ width: `${exportProgress.total > 0 ? (exportProgress.processed / exportProgress.total) * 100 : 0}%` }}
                    ></div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* OCR Confirmation Dialog */}
          {ocrConfirmation.show && (
            <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6" onClick={() =>
              setOcrConfirmation({ show: false, itemId: null, file: null, imageUrl: null })}>
              <div className="bg-[#1a1a1a] rounded-xl p-8 max-w-md w-full border border-[#2a2a2a]" onClick={(e) =>
                e.stopPropagation()}>
                <h3 className="text-xl font-bold mb-2 font-cn text-center">æ˜¯å¦ä½¿ç”¨è‡ªåŠ¨è¯†åˆ«ï¼Ÿ</h3>
                <p className="text-gray-500 text-xs text-center mb-6">Powered by Qwen</p>
                {ocrConfirmation.imageUrl && (
                  <div className="mb-6 flex justify-center">
                    <img src={ocrConfirmation.imageUrl} alt="Preview" className="max-h-48 rounded border border-[#2a2a2a]" />
                  </div>
                )}
                <div className="flex gap-4">
                  <button onClick={async () => {
                    const { itemId, file, imageUrl } = ocrConfirmation;
                    setOcrConfirmation({ show: false, itemId: null, file: null, imageUrl: null });
                    updateItem(itemId, 'previewUrl', imageUrl);
                    updateItem(itemId, 'file', file);
                    setIsProcessing(true);
                    try {
                      const reader = new FileReader();
                      const imageBase64 = await new Promise((resolve, reject) => {
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                      });
                      const response = await fetch('/api/ocr', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image: imageBase64 })
                      });
                      if (!response.ok) throw new Error('OCR failed');
                      const data = await response.json();

                      if (data) {
                        Object.entries(data).forEach(([key, value]) => {
                          if (value !== null && value !== undefined && value !== '') {
                            updateItem(itemId, key, value);
                          }
                        });
                      }
                    } catch (error) {
                      console.error('OCR Error:', error);
                      alert('OCRè¯†åˆ«å¤±è´¥ï¼š' + error.message);
                    } finally {
                      setIsProcessing(false);
                    }
                  }} className="flex-1 bg-yellow-500 hover:bg-yellow-600 text-black py-3 rounded-lg font-cn font-semibold
          transition">æ˜¯</button>
                  <button onClick={() => {
                    const { itemId, imageUrl, file } = ocrConfirmation;
                    updateItem(itemId, 'previewUrl', imageUrl);
                    updateItem(itemId, 'file', file);
                    setOcrConfirmation({ show: false, itemId: null, file: null, imageUrl: null });
                  }} className="flex-1 bg-[#2a2a2a] hover:bg-[#3a3a3a] text-gray-300 py-3 rounded-lg font-cn
          transition">å¦</button>
                </div>
              </div>
            </div>
          )}

          {/* Tutorial Welcome Card */}
          {showTutorial && (
            <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
              <div className="card-modern rounded-2xl p-8 max-w-2xl w-full relative animate-fade-in">
                <button onClick={closeTutorial} className="absolute top-4 right-4 text-gray-400 hover:text-white transition">
                  <X size={24} />
                </button>

                <div className="text-center mb-6">
                  <div className="w-40 h-15 items-center justify-center mx-auto mb-4 overflow-hidden">
                    <img src="assets/logo.png" alt="Kairos Studio" className="w-full h-full object-contain" />
                  </div>
                  <h2 className="text-2xl font-bold mb-2 font-cn">æ¬¢è¿ä½¿ç”¨ Kairos Studio æŠ¥é”€å•æ•´ç†å·¥å…·</h2>
                  <p className="text-gray-400 text-sm font-en">QUICK START GUIDE</p>
                </div>

                <div className="space-y-4 mb-6">
                  <div className="flex gap-4 items-start">
                    <div className="w-8 h-8 bg-yellow-400/10 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                      <span className="text-yellow-400 font-bold">1</span>
                    </div>
                    <div>
                      <h3 className="font-semibold mb-1 font-cn">å¡«å†™æŠ¥é”€ä¿¡æ¯</h3>
                      <p className="text-sm text-gray-400">è¾“å…¥æŠ¥é”€äººã€æ‰€å±é¡¹ç›®ã€æŠ¥é”€æ—¥æœŸå’Œæ”¶æ¬¾ä¿¡æ¯</p>
                    </div>
                  </div>

                  <div className="flex gap-4 items-start">
                    <div className="w-8 h-8 bg-yellow-400/10 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                      <span className="text-yellow-400 font-bold">2</span>
                    </div>
                    <div>
                      <h3 className="font-semibold mb-1 font-cn">ä¸Šä¼ å‘ç¥¨</h3>
                      <p className="text-sm text-gray-400">æ”¯æŒ JPGã€PNGã€PDF æ ¼å¼ï¼ŒOCR è‡ªåŠ¨è¯†åˆ«å‘ç¥¨ä¿¡æ¯</p>
                    </div>
                  </div>

                  <div className="flex gap-4 items-start">
                    <div className="w-8 h-8 bg-yellow-400/10 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                      <span className="text-yellow-400 font-bold">3</span>
                    </div>
                    <div>
                      <h3 className="font-semibold mb-1 font-cn">è¡¥å……å›¾ç‰‡</h3>
                      <p className="text-sm text-gray-400">æ‹–æ‹½ä¸Šä¼ è®¢å•å›¾å’Œæ”¯ä»˜å‡­è¯ï¼ˆå¯é€‰ï¼‰</p>
                    </div>
                  </div>

                  <div className="flex gap-4 items-start">
                    <div className="w-8 h-8 bg-yellow-400/10 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                      <span className="text-yellow-400 font-bold">4</span>
                    </div>
                    <div>
                      <h3 className="font-semibold mb-1 font-cn">å¯¼å‡ºæŠ¥é”€å•</h3>
                      <p className="text-sm text-gray-400">ä¸€é”®å¯¼å‡º Excel æˆ– PDF æ ¼å¼ï¼Œå›¾ç‰‡è‡ªåŠ¨åµŒå…¥</p>
                    </div>
                  </div>
                </div>

                <button onClick={closeTutorial} className="w-full btn-primary py-3 rounded-lg font-semibold font-cn">
                  å¼€å§‹ä½¿ç”¨
                </button>
              </div>
            </div>
          )}
          {/* Hidden PDF Content - Always in DOM for export */}
          <div style={{ position: 'absolute', left: '-9999px', top: '0' }}>
            <PDFContent items={pdfItems || items} reimbursementInfo={reimbursementInfo} columns={columns} />
          </div>

          {/* Visible UI */}
          <header className="border-b border-[#2a2a2a] px-8 py-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <img src="assets/logo.png" alt="Logo" className="h-10 opacity-80 hover:opacity-100 transition-opacity" />
              </div>
              <div className="flex items-center gap-6">
                {/* Auto-save Switch */}
                <div
                  className="flex items-center gap-2 cursor-pointer group"
                  onClick={() => setAutoSaveEnabled(!autoSaveEnabled)}
                  title="Toggle Auto-save"
                >
                  <div className={`w-8 h-4 rounded-full p-0.5 transition-colors duration-300 ${autoSaveEnabled ? 'bg-yellow-400' : 'bg-gray-700'}`}>
                    <div className={`w-3 h-3 bg-black rounded-full shadow-sm transform transition-transform duration-300 ${autoSaveEnabled ? 'translate-x-4' : 'translate-x-0'}`}></div>
                  </div>
                  <span className="text-[10px] text-gray-500 font-en tracking-wider group-hover:text-gray-300 transition-colors">AUTO SAVE</span>
                </div>

                {/* Breathing Status */}
                <div className="flex items-center gap-2 pl-4 border-l border-gray-800">
                  <div className={`w-2 h-2 rounded-full transition-all duration-500 ${saveStatus === 'saving' ? 'bg-yellow-500 shadow-[0_0_8px_rgba(234,179,8,0.6)] animate-pulse' : 'bg-transparent border border-gray-600'}`}></div>
                  <span className={`text-[10px] font-en tracking-widest ${saveStatus === 'saving' ? 'text-yellow-500' : 'text-gray-600'}`}>
                    {saveStatus === 'saving' ? 'SAVING...' : 'READY'}
                  </span>
                </div>
              </div>
            </div>
          </header>

          {/* Main Content */}
          <main className="max-w-7xl mx-auto p-6 space-y-6">

            {/* Reimbursement Info & Upload */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">

              {/* Upload Zone */}
              <div className={`upload-zone rounded-xl p-8 flex flex-col items-center justify-center text-center cursor-pointer
        ${isDragging ? 'drag-active' : ''}`} onDragOver={onDragOver} onDragLeave={onDragLeave} onDrop={onDrop}
                onClick={() => document.getElementById('fileInput').click()}
              >
                <input type="file" id="fileInput" multiple className="hidden" onChange={(e) => handleFiles(e.target.files)} />
                <div className="w-14 h-14 bg-[#1a1a1a] rounded-full flex items-center justify-center mb-4">
                  {isProcessing ?
                    <RefreshCw className="animate-spin text-yellow-400" size={28} /> :
                    <Upload className="text-yellow-400" size={28} />}
                </div>
                <p className="text-sm font-semibold mb-2 font-cn">ä¸Šä¼ å‘ç¥¨</p>
                <p className="text-xs text-gray-400 mb-1 font-cn">è‡ªåŠ¨è¯†åˆ«æ–‡å­—å†…å®¹å¡«å……</p>
                <p className="text-xs text-gray-500 font-en">æ”¯æŒæ ¼å¼ï¼šJPGã€PNGã€PDF</p>

              </div>

              {/* History Sidebar */}
              {typeof HistorySidebar !== 'undefined' && (
                <HistorySidebar
                  isOpen={showHistory}
                  onClose={() => setShowHistory(false)}
                  onRestore={(record) => {
                    if (record.items && record.items.length > 0) {
                      setItems(record.items);
                      setReimbursementInfo({
                        reimburser: record.reimburser || '',
                        project: record.project || '',
                        reimbursementDate: record.date || new Date().toISOString().split('T')[0],
                        paymentInfo: '' // Don't enforce this on restore if not saved, or maybe it should be?
                      });
                    }
                  }}
                />
              )}

              {/* Reimbursement Info */}
              <div className="lg:col-span-2 card-modern rounded-xl p-6">
                <div className="flex items-center justify-between mb-4 pb-3 border-b border-[#2a2a2a]">
                  <div className="flex items-center gap-2">
                    <Settings size={18} className="text-yellow-400" />
                    <span className="font-semibold text-sm font-cn">æŠ¥é”€å•ä¿¡æ¯</span>
                    <span className="text-xs text-gray-500 font-en">REIMBURSEMENT INFO</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <button
                      onClick={handleSaveProject}
                      className="flex items-center gap-1.5 px-3 py-1.5 bg-yellow-400 hover:bg-yellow-500 text-black text-xs font-bold rounded transition-colors font-cn shadow-sm"
                    >
                      SAVE PROJECT
                    </button>
                    <button
                      onClick={handleCleanProject}
                      className="flex items-center gap-1.5 px-3 py-1.5 border border-gray-600 text-gray-400 hover:text-white hover:border-white text-xs font-bold rounded transition-colors font-en"
                    >
                      CLEAN
                    </button>
                    <button
                      onClick={() => setShowHistory(true)}
                      className="ml-2 text-gray-500 hover:text-yellow-400 transition-colors flex items-center gap-1.5 text-xs font-cn"
                    >
                      <Clock size={14} />
                      <span>ç‰ˆæœ¬è®°å½•</span>
                    </button>
                  </div>
                </div>
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                  <div>
                    <label className="text-xs text-gray-500 mb-1.5 block font-cn">æŠ¥é”€äºº</label>
                    <input type="text" className="w-full px-3 py-2.5 input-modern rounded-lg text-sm" placeholder="ä¾‹ï¼šé»„é¸Ÿ"
                      value={reimbursementInfo.reimburser} onChange={e => setReimbursementInfo({
                        ...reimbursementInfo,
                        reimburser: e.target.value
                      })}
                    />
                  </div>
                  <div>
                    <label className="text-xs text-gray-500 mb-1.5 block font-cn">æ‰€å±é¡¹ç›®</label>
                    <input type="text" className="w-full px-3 py-2.5 input-modern rounded-lg text-sm" placeholder="ä¾‹ï¼š11-12 æœˆæŠ¥é”€"
                      maxLength={30}
                      value={reimbursementInfo.project} onChange={e => setReimbursementInfo({
                        ...reimbursementInfo, project:
                          e.target.value
                      })}
                    />
                  </div>
                  <div>
                    <label className="text-xs text-gray-500 mb-1.5 block font-cn">æŠ¥é”€æ—¥æœŸ</label>
                    <input type="date" className="w-full px-3 py-2.5 input-modern rounded-lg text-sm"
                      value={reimbursementInfo.reimbursementDate} onChange={e => setReimbursementInfo({
                        ...reimbursementInfo,
                        reimbursementDate: e.target.value
                      })}
                    />
                  </div>
                </div>
                <div className="mt-4">
                  <label className="text-xs text-gray-500 mb-1.5 block font-cn">æ”¶æ¬¾ä¿¡æ¯</label>
                  <input type="text" className="w-full px-3 py-2.5 input-modern rounded-lg text-sm" placeholder="è¯·è¾“å…¥é“¶è¡Œå¡å·æˆ–æ”¶æ¬¾è´¦æˆ·ä¿¡æ¯"
                    value={reimbursementInfo.paymentInfo} onChange={e => setReimbursementInfo({
                      ...reimbursementInfo,
                      paymentInfo: e.target.value
                    })}
                  />
                </div>
              </div>
            </div>

            {/* Processing Queue */}
            {
              processingQueue.length > 0 && (
                <div className="card-modern rounded-xl p-5">
                  <h3 className="text-sm font-semibold mb-4 font-cn">å¤„ç†è¿›åº¦</h3>
                  <div className="space-y-3">
                    {processingQueue.map(item => (
                      <div key={item.id} className="space-y-1.5">
                        <div className="flex justify-between text-xs">
                          <span className="text-gray-400 font-en">{item.name}</span>
                          <span className={`font-semibold ${item.status === 'completed' ? 'text-green-400' : item.status === 'failed'
                            ? 'text-red-400' : 'text-yellow-400'} font-cn`}>
                            {item.status === 'waiting' && 'ç­‰å¾…ä¸­'}
                            {item.status === 'processing' && 'å¤„ç†ä¸­...'}
                            {item.status === 'completed' && 'å®Œæˆ'}
                            {item.status === 'failed' && 'å¤±è´¥'}
                          </span>
                        </div>
                        <div className="progress-bar h-1.5">
                          <div className={`progress-fill ${item.status === 'failed' ? 'bg-red-500' : ''}`} style={{
                            width:
                              `${item.progress}%`
                          }} />
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )
            }

            {/* Items Table Component */}
            <ReimbursementTable
              items={items}
              setItems={setItems}
              columns={columns}
              setColumns={setColumns}
              toggleRow={toggleRow}
              expandedRows={expandedRows}
              updateItem={updateItem}
              deleteItem={deleteItem}
              handleImageUpload={handleImageUpload}
              setOcrConfirmation={setOcrConfirmation}
              setPdfPreviewUrl={setPdfPreviewUrl}
              addNewRow={addNewRow}
              setShowColumnManager={setShowColumnManager}
              setShowExportPreview={setShowExportPreview}
              initialColumns={initialColumns}
              isProcessing={isProcessing}
              reimbursementInfo={reimbursementInfo}
            />

            {/* Column Management Modal */}
            {
              showColumnManager && (
                <div
                  className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 animate-fade-in"
                  onClick={() => setShowColumnManager(false)}
                >
                  <div
                    className="bg-[#1a1a1a] rounded-xl p-6 w-full max-w-md border border-[#2a2a2a] shadow-2xl"
                    onClick={e => e.stopPropagation()}
                  >
                    <div className="flex justify-between items-center mb-6 border-b border-[#2a2a2a] pb-4">
                      <h3 className="font-bold font-cn text-lg flex items-center gap-2">
                        <Settings size={18} className="text-yellow-500" />
                        åˆ—æ˜¾ç¤ºè®¾ç½®
                      </h3>
                      <button onClick={() => setShowColumnManager(false)} className="text-gray-400 hover:text-white transition bg-[#2a2a2a] hover:bg-[#333] p-1.5 rounded-full">
                        <X size={16} />
                      </button>
                    </div>
                    <div className="space-y-3 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
                      {columns.map(col => (
                        <label key={col.id} className={`flex items-center gap-3 p-3 rounded-lg cursor-pointer border transition border-transparent hover:border-[#333] ${col.visible ? 'bg-[#252525]' : 'bg-[#151515] opacity-60 hover:opacity-100'}`}>
                          <input
                            type="checkbox"
                            checked={col.visible}
                            disabled={col.fixed}
                            onChange={() => {
                              if (col.fixed) return;
                              setColumns(cols => cols.map(c =>
                                c.id === col.id ? { ...c, visible: !c.visible } : c
                              ));
                            }}
                            className={`w-4 h-4 rounded border-gray-600 bg-[#333] focus:ring-yellow-500 focus:ring-offset-[#1a1a1a] ${col.fixed ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`}
                          />
                          <span className={`text-sm ${col.visible ? 'text-gray-200 font-medium' : 'text-gray-500'}`}>{col.label}</span>
                          {col.fixed && <span className="text-xs text-yellow-500/50 ml-auto bg-yellow-500/10 px-2 py-0.5 rounded">å¿…é€‰</span>}
                        </label>
                      ))}
                    </div>
                  </div>
                </div>
              )
            }

            {/* Export Preview Modal */}
            {
              showExportPreview && (
                <div
                  className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 animate-fade-in"
                  onClick={() => setShowExportPreview(false)}
                >
                  <div
                    className="bg-[#1a1a1a] rounded-xl w-full max-w-7xl h-[90vh] flex border border-[#2a2a2a] shadow-2xl overflow-hidden"
                    onClick={e => e.stopPropagation()}
                  >
                    {/* Left Sidebar - Column Settings */}
                    <div className="w-64 bg-[#141414] border-r border-[#2a2a2a] flex flex-col">
                      <div className="p-4 border-b border-[#2a2a2a]">
                        <h3 className="font-bold font-cn text-lg flex items-center gap-2 text-white">
                          <Settings size={18} className="text-yellow-500" />
                          å¯¼å‡ºåˆ—è®¾ç½®
                        </h3>
                        <p className="text-xs text-gray-500 mt-1">å‹¾é€‰ä»¥åŒ…å«åœ¨å¯¼å‡ºæ–‡ä»¶ä¸­</p>
                      </div>
                      <div className="flex-1 overflow-y-auto p-2 custom-scrollbar">
                        {columns.map(col => (
                          <label key={col.id} className={`flex items-center gap-3 p-2.5 rounded-lg cursor-pointer transition border border-transparent hover:bg-[#252525] ${col.visible ? 'text-gray-200' : 'text-gray-500'}`}>
                            <input
                              type="checkbox"
                              checked={col.visible}
                              disabled={col.fixed}
                              onChange={() => {
                                if (col.fixed) return;
                                setColumns(cols => cols.map(c =>
                                  c.id === col.id ? { ...c, visible: !c.visible } : c
                                ));
                              }}
                              className={`w-4 h-4 rounded border-gray-600 bg-[#333] focus:ring-yellow-500 focus:ring-offset-[#1a1a1a] ${col.fixed ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`}
                            />
                            <span className="text-sm font-medium flex-1">{col.label}</span>
                            {col.fixed && <span className="text-[10px] text-yellow-500/70 bg-yellow-500/10 px-1.5 py-0.5 rounded">å¿…é€‰</span>}
                          </label>
                        ))}
                      </div>
                    </div>

                    {/* Right Content - Preview */}
                    <div className="flex-1 flex flex-col bg-[#1a1a1a]">
                      {/* Header */}
                      <div className="flex justify-between items-center p-4 border-b border-[#2a2a2a] bg-[#1a1a1a]">
                        <div className="flex items-center gap-6">
                          <h3 className="font-bold font-cn text-lg flex items-center gap-2">
                            <Eye size={18} className="text-yellow-500" />
                            å¯¼å‡ºé¢„è§ˆ
                          </h3>
                          <div className="flex bg-[#0f0f0f] rounded-lg p-1 border border-[#2a2a2a]">
                            <button
                              onClick={() => setPreviewTab('excel')}
                              className={`px-4 py-1.5 text-xs rounded-md transition font-medium flex items-center gap-2 ${previewTab === 'excel' ? 'bg-[#2a2a2a] text-white shadow-sm' : 'text-gray-500 hover:text-gray-300'}`}
                            >
                              <FileText size={14} /> Excel é¢„è§ˆ
                            </button>
                            <button
                              onClick={() => setPreviewTab('pdf')}
                              className={`px-4 py-1.5 text-xs rounded-md transition font-medium flex items-center gap-2 ${previewTab === 'pdf' ? 'bg-[#2a2a2a] text-white shadow-sm' : 'text-gray-500 hover:text-gray-300'}`}
                            >
                              <Briefcase size={14} /> PDF æ‰“å°é¢„è§ˆ
                            </button>
                          </div>
                        </div>
                        <button onClick={() => setShowExportPreview(false)} className="text-gray-400 hover:text-white bg-[#2a2a2a] hover:bg-[#333] p-2 rounded-full transition">
                          <X size={18} />
                        </button>
                      </div>

                      {/* Preview Area */}
                      <div className="flex-1 overflow-auto bg-[#0a0a0a] p-8 relative flex justify-center">
                        {previewTab === 'excel' ? (
                          <div className="bg-white text-black p-10 shadow-xl min-h-full w-full max-w-5xl overflow-x-auto">
                            <div className="flex justify-between items-end mb-8 border-b-2 border-gray-800 pb-4">
                              <h1 className="text-3xl font-bold text-gray-800">æŠ¥é”€å• (Excel é¢„è§ˆ)</h1>
                              <div className="text-right text-xs text-gray-500">
                                <p className="mb-1"><span className="font-bold">æŠ¥é”€äºº:</span> {reimbursementInfo.reimburser || '-'}</p>
                                <p className="mb-1"><span className="font-bold">é¡¹ç›®:</span> {reimbursementInfo.project || '-'}</p>
                                <p className="mb-1"><span className="font-bold">æ—¥æœŸ:</span> {reimbursementInfo.reimbursementDate || '-'}</p>
                                <p><span className="font-bold">æ‰“æ¬¾ä¿¡æ¯:</span> {reimbursementInfo.paymentInfo || '-'}</p>
                              </div>
                            </div>
                            <table className="w-full border-collapse border border-gray-300 text-xs table-fixed">
                              <thead>
                                <tr className="bg-gray-100">
                                  {columns.filter(c => c.visible && c.id !== 'actions').map(col => (
                                    <th key={col.id} className="border border-gray-300 p-2 text-left font-bold text-gray-700 bg-gray-50">{col.label}</th>
                                  ))}
                                </tr>
                              </thead>
                              <tbody>
                                {items.map((item, idx) => (
                                  <tr key={item.id} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                    {columns.filter(c => c.visible && c.id !== 'actions').map(col => (
                                      <td key={col.id} className="border border-gray-300 p-2 text-left text-gray-600 truncate max-w-[150px]" title={typeof item[col.id] === 'string' ? item[col.id] : ''}>
                                        {/* Specialized rendering for image columns in preview */}
                                        {['preview', 'orderImage', 'paymentProof'].includes(col.id) ? (
                                          (() => {
                                            let url = null;
                                            if (col.id === 'preview') url = item.previewUrl || item.preview;
                                            else if (col.id === 'orderImage') url = item.orderImageUrl || item.orderImage;
                                            else if (col.id === 'paymentProof') url = item.paymentProofUrl || item.paymentProof;

                                            return url ? (
                                              <img src={url} alt={col.label} className="h-10 w-10 object-cover rounded border border-gray-200" />
                                            ) : <span className="text-gray-300">-</span>;
                                          })()
                                        ) : (
                                          item[col.id]
                                        )}
                                      </td>
                                    ))}
                                  </tr>
                                ))}
                              </tbody>
                              <tfoot>
                                <tr className="bg-yellow-50 font-bold">
                                  {/* Calculate colspan dynamically based on visible columns */}
                                  <td colSpan={columns.filter(c => c.visible && c.id !== 'actions').length - 1} className="border border-gray-300 p-2 text-right">æ€»è®¡:</td>
                                  <td className="border border-gray-300 p-2 text-left">Â¥{formatCurrency(items.reduce((sum, item) => sum + Number(item.amount || 0), 0))}</td>
                                </tr>
                              </tfoot>
                            </table>
                          </div>
                        ) : (
                          <div className="transform scale-90 origin-top shadow-2xl">
                            <PDFContent items={items} reimbursementInfo={reimbursementInfo} columns={columns} />
                          </div>
                        )}
                      </div>

                      {/* Footer */}
                      <div className="p-4 border-t border-[#2a2a2a] bg-[#1a1a1a] flex justify-end gap-3 z-10">
                        <button onClick={() => setShowExportPreview(false)} className="px-6 py-2.5 text-gray-400 hover:text-white transition text-sm">å–æ¶ˆ</button>
                        {previewTab === 'excel' ? (
                          <button
                            onClick={() => exportToExcel(items, columns, reimbursementInfo)}
                            className="btn-primary px-8 py-2.5 rounded-lg font-bold flex items-center gap-2 text-sm shadow-lg shadow-yellow-500/20"
                          >
                            <Download size={18} />
                            <span>å¯¼å‡º Excel æ–‡ä»¶</span>
                          </button>
                        ) : (
                          <button
                            onClick={() => exportToPrint(items, columns, reimbursementInfo)}
                            className="btn-primary px-8 py-2.5 rounded-lg font-bold flex items-center gap-2 text-sm shadow-lg shadow-yellow-500/20"
                          >
                            <Download size={18} />
                            <span>å»æ‰“å° / å¦å­˜ä¸º PDF</span>
                          </button>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              )
            }

            {/* Footer */}
            <footer className="mt-8 pb-6 text-center text-xs text-gray-600">
              <button
                onClick={() => setShowTutorial(true)}
                className="text-gray-500 hover:text-gray-400 transition mb-3 block mx-auto font-cn"
              >
                æŸ¥çœ‹æ•™ç¨‹
              </button>
              <div className="flex items-center justify-center gap-2 mb-1">
                <span>v1.0.1-alpha</span>
                <span>â€¢</span>
                <span>Â© Kairos Studio 2026</span>
              </div>
              <p className="text-gray-700 mt-1">Powered by Qwen</p>
            </footer>

          </main >

          {/* PDF Preview Modal */}
          {
            pdfPreviewUrl && (
              <div
                className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-6"
                onClick={() => setPdfPreviewUrl(null)}
              >
                <div className="relative w-full max-w-4xl max-h-[90vh] bg-[#141414] rounded-xl overflow-hidden">
                  <div className="flex justify-between items-center p-4 border-b border-[#2a2a2a]">
                    <span className="font-semibold font-cn">PDF é¢„è§ˆ</span>
                    <button onClick={() => setPdfPreviewUrl(null)} className="p-2 hover:bg-[#2a2a2a] rounded">
                      <X size={20} />
                    </button>
                  </div>
                  <embed src={pdfPreviewUrl} type="application/pdf" className="w-full h-[80vh]" />
                </div>
              </div>
            )
          }
          {/* Draft Restore Prompt */}
          {showDraftPrompt && (
            <div className="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 animate-fade-in">
              <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm border border-gray-100">
                <div className="flex items-center gap-3 mb-4">
                  <div className="bg-yellow-100 p-2 rounded-full text-yellow-600">
                    <Clock size={20} />
                  </div>
                  <div>
                    <h3 className="font-bold text-gray-900 font-cn">å‘ç°æœªä¿å­˜çš„è‰ç¨¿</h3>
                    <p className="text-xs text-gray-500 font-en">UNSAVED DRAFT FOUND</p>
                  </div>
                </div>
                <p className="text-sm text-gray-600 mb-6 font-cn leading-relaxed">
                  ç³»ç»Ÿæ£€æµ‹åˆ°æ‚¨ä¸Šæ¬¡æœ‰æœªå®Œæˆçš„ç¼–è¾‘ï¼Œæ˜¯å¦æ¢å¤ï¼Ÿ
                  <br />
                  <span className="text-xs text-gray-400 mt-1 block">
                    {draftData && new Date(draftData.timestamp).toLocaleString()}
                  </span>
                </p>
                <div className="flex gap-3">
                  <button
                    onClick={handleDiscardDraft}
                    className="flex-1 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg text-sm font-medium transition-colors font-cn"
                  >
                    ä¸¢å¼ƒ
                  </button>
                  <button
                    onClick={handleRestoreDraft}
                    className="flex-1 py-2.5 bg-yellow-400 hover:bg-yellow-500 text-black rounded-lg text-sm font-bold shadow-lg shadow-yellow-500/20 transition-colors font-cn"
                  >
                    æ¢å¤
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Toast Notification */}
          {showToast && (
            <div className="fixed top-6 right-1/2 translate-x-1/2 z-[70] animate-in fade-in slide-in-from-top-4 duration-300">
              <div className="bg-green-500 text-black px-6 py-3 rounded-full shadow-2xl flex items-center gap-2">
                <div className="bg-black text-green-500 rounded-full p-0.5">
                  <Check size={14} strokeWidth={3} />
                </div>
                <span className="font-bold font-cn text-sm tracking-wide">ä¿å­˜æˆåŠŸ</span>
              </div>
            </div>
          )}

          {/* Close Project Dialog */}
          {showCloseDialog && (
            <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-in fade-in duration-200">
              <div className="bg-[#1e1e1e] border border-gray-800 rounded-xl max-w-sm w-full p-6 shadow-2xl">
                <div className="flex items-center justify-center w-12 h-12 bg-yellow-400/10 rounded-full mb-4 mx-auto">
                  <Briefcase size={24} className="text-yellow-400" />
                </div>
                <h3 className="text-lg font-bold text-white text-center mb-2 font-cn">ç¡®è®¤æ¸…ç©ºé¡¹ç›®</h3>
                <p className="text-gray-400 text-sm text-center mb-6 font-cn">
                  æ£€æµ‹åˆ°é¡¹ç›®ä¿¡æ¯æœªå®Œå–„ã€‚æ¸…ç©ºå°†å¯¼è‡´å½“å‰è¿›åº¦(Draft)ä¸¢å¤±ã€‚
                </p>
                <div className="flex gap-3">
                  <button
                    onClick={() => {
                      resetWorkspace();
                      setShowCloseDialog(false);
                    }}
                    className="flex-1 py-2.5 bg-transparent border border-gray-700 hover:bg-gray-800 text-gray-400 rounded-lg text-sm font-medium transition-colors font-cn"
                  >
                    ç¡®è®¤æ¸…ç©º
                  </button>
                  <button
                    onClick={() => {
                      setShowCloseDialog(false);
                      // Focus project input? simple enough to just let user do it
                    }}
                    className="flex-1 py-2.5 bg-yellow-400 hover:bg-yellow-500 text-black rounded-lg text-sm font-bold shadow-lg shadow-yellow-500/20 transition-colors font-cn"
                  >
                    å‰å¾€å¡«å†™
                  </button>
                </div>
              </div>
            </div>
          )}

        </div >
      );
    }; // Close App component

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

    lucide.createIcons();
  </script>
</body>

</html>