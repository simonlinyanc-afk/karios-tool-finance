<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yellow Bird Finance Â· Kairos</title>

  <!-- Google Fonts: Source Han Sans (æ€æºé»‘ä½“) & Plus Jakarta Sans -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">

  <!-- React & Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <!-- html2pdf.js for PDF generation with Chinese support -->
  <script src="/libs/html2pdf.bundle.min.js"></script>

  <!-- PDF.js for PDF to Image conversion -->
  <script src="/libs/pdf.min.js"></script>
  <script>
    // Configure PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = '/libs/pdf.worker.min.js';
  </script>

  <!-- ExcelJS for Excel Export with Image Support -->
  <script src="/libs/exceljs.min.js"></script>

  <style>
    * {
      font-family: 'Noto Sans SC', 'Plus Jakarta Sans', sans-serif;
    }

    /* Swiss Typography */
    .font-cn {
      font-family: 'Noto Sans SC', sans-serif;
    }

    .font-en {
      font-family: 'Plus Jakarta Sans', sans-serif;
    }

    /* Modern Black Theme */
    body {
      background: #0a0a0a;
      color: #ffffff;
    }

    .card-modern {
      background: #141414;
      border: 1px solid #2a2a2a;
      transition: all 0.3s ease;
    }

    .card-modern:hover {
      border-color: #3a3a3a;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(80%) sepia(50%) saturate(500%) hue-rotate(0deg) brightness(100%);
      cursor: pointer;
    }

    .input-modern {
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      color: #ffffff;
      transition: all 0.2s ease;
    }

    .input-modern:focus {
      background: #1f1f1f;
      border-color: #fbbf24;
      outline: none;
      box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
    }

    .btn-primary {
      background: #fbbf24;
      color: #0a0a0a;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .btn-primary:hover {
      background: #f59e0b;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
    }

    .upload-zone {
      border: 2px dashed #2a2a2a;
      background: #0f0f0f;
      transition: all 0.3s ease;
    }

    .upload-zone:hover {
      border-color: #fbbf24;
      background: #141414;
    }

    .upload-zone.drag-active {
      border-color: #fbbf24;
      background: #1a1a1a;
      transform: scale(1.02);
    }

    .progress-bar {
      background: #1a1a1a;
      overflow: hidden;
      border-radius: 9999px;
    }

    .progress-fill {
      height: 100%;
      transition: width 0.3s ease;
      background: linear-gradient(90deg, #fbbf24, #f59e0b);
    }

    /* Table Styles */
    .table-modern {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    .table-modern th {
      background: #141414;
      color: #888;
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 1rem;
      border-bottom: 1px solid #2a2a2a;
      text-align: left;
    }

    .table-modern td {
      padding: 1rem;
      border-bottom: 1px solid #1a1a1a;
    }

    .table-modern tr:hover {
      background: #141414;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #0a0a0a;
    }

    ::-webkit-scrollbar-thumb {
      background: #2a2a2a;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #3a3a3a;
    }

    /* PDF Preview Specific Styles */
    .pdf-preview-container {
      background-color: #ffffff;
      color: #000000;
      padding: 20mm;
      box-sizing: border-box;
      font-family: 'Noto Sans SC', sans-serif;
      font-size: 10pt;
      line-height: 1.5;
    }

    .pdf-preview-container h1 {
      font-size: 20pt;
      text-align: center;
      margin-bottom: 20pt;
      font-weight: bold;
    }

    .pdf-preview-container .info-section {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15pt;
      border-bottom: 1px solid #eee;
      padding-bottom: 5pt;
    }

    .pdf-preview-container .info-item {
      flex: 1;
      margin-right: 10pt;
    }

    .pdf-preview-container .info-item:last-child {
      margin-right: 0;
    }

    .pdf-preview-container .info-label {
      font-weight: bold;
      margin-right: 5pt;
    }

    .pdf-preview-container table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20pt;
    }

    .pdf-preview-container th,
    .pdf-preview-container td {
      border: 1px solid #ddd;
      padding: 8pt;
      text-align: left;
    }

    .pdf-preview-container th {
      background-color: #f2f2f2;
      font-weight: bold;
    }

    .pdf-preview-container .total-row {
      font-weight: bold;
      background-color: #f9f9f9;
    }

    .pdf-preview-container .signature-section {
      display: flex;
      justify-content: space-around;
      margin-top: 40pt;
      text-align: center;
    }

    .pdf-preview-container .signature-item {
      flex: 1;
    }

    .pdf-preview-container .signature-line {
      border-bottom: 1px solid #000;
      width: 80%;
      margin: 10pt auto 0;
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Create Icon component that renders SVG directly without lucide.createIcons()
    const Icon = ({ path, size = 20, className = "", strokeWidth = 2, ...props }) => {
      return React.createElement('svg', {
        xmlns: 'http://www.w3.org/2000/svg',
        width: size,
        height: size,
        viewBox: '0 0 24 24',
        fill: 'none',
        stroke: 'currentColor',
        strokeWidth: strokeWidth,
        strokeLinecap: 'round',
        strokeLinejoin: 'round',
        className: className,
        ...props
      }, React.createElement('path', { d: path }));
    };

    // Icon SVG paths (from Lucide)
    const Upload = (props) => React.createElement(Icon, { path: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12', ...props });
    const FileText = (props) => React.createElement(Icon, { path: 'M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2zM14 2v6h6M16 13H8M16 17H8M10 9H8', ...props });
    const Settings = (props) => React.createElement(Icon, { path: 'M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2zM12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z', ...props });
    const Eye = (props) => React.createElement(Icon, { path: 'M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7zM15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0z', ...props });
    const User = (props) => React.createElement(Icon, { path: 'M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2M16 7a4 4 0 1 1-8 0 4 4 0 0 1 8 0z', ...props });
    const Briefcase = (props) => React.createElement(Icon, { path: 'M16 20V4a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16m0-16H6a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-2', ...props });
    const Calendar = (props) => React.createElement(Icon, { path: 'M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z', ...props });
    const Download = (props) => React.createElement(Icon, { path: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3', ...props });
    const X = (props) => React.createElement(Icon, { path: 'M18 6 6 18M6 6l12 12', ...props });
    const ChevronDown = (props) => React.createElement(Icon, { path: 'm6 9 6 6 6-6', ...props });
    const ChevronUp = (props) => React.createElement(Icon, { path: 'm18 15-6-6-6 6', ...props });
    const Plus = (props) => React.createElement(Icon, { path: 'M5 12h14M12 5v14', ...props });
    const Image = (props) => React.createElement(Icon, { path: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M14.5 2H6a2 2 0 0 0-2 2v12l5-5 4 4 7-7V7.5L14.5 2zM14 2v6h6M9.5 9.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z', ...props });
    const RefreshCw = (props) => React.createElement(Icon, { path: 'M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8M3 16l2.26 2.26A9.75 9.75 0 0 0 12 21a9 9 0 0 0 9-9', ...props });

    // Yellow Bird Finance Logo as inline SVG
    const LogoSVG = () => React.createElement('svg', {
      width: '160',
      height: '24',
      viewBox: '0 0 300 53',
      fill: 'none',
      className: 'h-6',
      xmlns: 'http://www.w3.org/2000/svg'
    },
      React.createElement('text', {
        x: '0',
        y: '40',
        fill: '#FFFFFF',
        fontSize: '36',
        fontFamily: 'Noto Sans SC, sans-serif',
        fontWeight: '500'
      }, 'é»„é¸Ÿè´¢åŠ¡åŠ©æ‰‹')
    );

    const App = () => {
      // State
      const [items, setItems] = useState([]);
      const [isDragging, setIsDragging] = useState(false);
      const [isProcessing, setIsProcessing] = useState(false);
      const [pdfPreviewUrl, setPdfPreviewUrl] = useState(null);
      const [ocrConfirmation, setOcrConfirmation] = useState({
        show: false,
        itemId: null,
        file: null,
        imageUrl: null
      });
      const [processingQueue, setProcessingQueue] = useState([]);
      const [expandedRows, setExpandedRows] = useState(new Set());

      const [reimbursementInfo, setReimbursementInfo] = useState({
        reimburser: '',
        project: '',
        reimbursementDate: new Date().toISOString().split('T')[0],
        paymentInfo: ''
      });

      const [showTutorial, setShowTutorial] = useState(() => {
        return !localStorage.getItem('tutorialCompleted');
      });

      const [pdfItems, setPdfItems] = useState(null);

      const closeTutorial = () => {
        localStorage.setItem('tutorialCompleted', 'true');
        setShowTutorial(false);
      };

      // Initial Columns Definition
      const initialColumns = [
        { id: 'preview', label: 'å‘ç¥¨å›¾', visible: true, fixed: true, width: 'w-20' },
        { id: 'orderImage', label: 'è®¢å•å›¾', visible: true, width: 'w-20' },
        { id: 'paymentProof', label: 'æ”¯ä»˜å‡­è¯', visible: true, width: 'w-20' },
        { id: 'date', label: 'æ—¥æœŸ', visible: true, width: 'w-32' },
        { id: 'category', label: 'ç±»åˆ«', visible: true, width: 'w-24' },
        { id: 'description', label: 'æè¿°', visible: true, width: 'w-48' },
        { id: 'subtotal', label: 'é‡‘é¢ï¼ˆç¨å‰ï¼‰', visible: true, width: 'w-32' },
        { id: 'taxRate', label: 'ç¨ç‡', visible: true, width: 'w-20' },
        { id: 'tax', label: 'ç¨é¢', visible: true, width: 'w-24' },
        { id: 'amount', label: 'é‡‘é¢ï¼ˆç¨åï¼‰', visible: true, width: 'w-32' },
        { id: 'invoiceNumber', label: 'å‘ç¥¨å·ç ', visible: false, width: 'w-36' },
        { id: 'buyerName', label: 'è´­ä¹°æ–¹', visible: false, width: 'w-48' },

        { id: 'sellerName', label: 'é”€å”®æ–¹', visible: false, width: 'w-48' },
        { id: 'itemName', label: 'é¡¹ç›®åç§°', visible: false, width: 'w-48' },
        { id: 'specification', label: 'è§„æ ¼å‹å·', visible: false, width: 'w-32' },
        { id: 'quantity', label: 'æ•°é‡', visible: false, width: 'w-24' },
        { id: 'unit', label: 'å•ä½', visible: false, width: 'w-20' },
        { id: 'unitPrice', label: 'å•ä»·', visible: false, width: 'w-28' },
        { id: 'actions', label: 'æ“ä½œ', visible: true, fixed: true, width: 'w-24' },
      ];

      const [columns, setColumns] = useState(initialColumns);
      const [showColumnManager, setShowColumnManager] = useState(false);
      const [showExportPreview, setShowExportPreview] = useState(false);
      const [previewTab, setPreviewTab] = useState('excel'); // 'excel' or 'pdf'

      // Convert PDF to Image using PDF.js
      const convertPDFToImage = async (file) => {
        try {
          const arrayBuffer = await file.arrayBuffer();
          const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
          const page = await pdf.getPage(1); // Get first page
          const viewport = page.getViewport({ scale: 2 }); // 2x scale for better quality

          const canvas = document.createElement('canvas');
          canvas.width = viewport.width;
          canvas.height = viewport.height;

          await page.render({
            canvasContext: canvas.getContext('2d'),
            viewport
          }).promise;

          // Convert canvas to blob and return as File object
          return new Promise((resolve) => {
            canvas.toBlob((blob) => {
              const imageFile = new File([blob], file.name.replace('.pdf', '.png'), { type: 'image/png' });
              resolve(imageFile);
            }, 'image/png');
          });
        } catch (error) {
          console.error('PDF conversion error:', error);
          return null;
        }
      };

      // File Upload Handler
      const handleFiles = async (files) => {
        setIsProcessing(true);
        const newItems = [];
        const filesArray = Array.from(files);

        // ... processing logic ...
        // Simplified for brevity, reusing logic but mapping new fields
        const queue = filesArray.map((file, index) => ({
          id: Date.now() + index,
          name: file.name,
          status: 'waiting',
          progress: 0
        }));
        setProcessingQueue(queue);

        for (let i = 0; i < filesArray.length; i++) {
          const file = filesArray[i];
          const queueItem = queue[i];
          const isPDF = file.type === "application/pdf" || file.name.toLowerCase().endsWith(".pdf");

          setProcessingQueue(prev => prev.map(item =>
            item.id === queueItem.id ? { ...item, status: 'processing', progress: 50 } : item
          ));

          try {
            // If it's a PDF, convert to image first
            let fileToProcess = file;
            let convertedImageUrl = null;

            if (isPDF) {
              const convertedFile = await convertPDFToImage(file);
              if (convertedFile) {
                fileToProcess = convertedFile;
                convertedImageUrl = URL.createObjectURL(convertedFile);
              }
            }

            // Convert image to base64
            const reader = new FileReader();
            const imageBase64 = await new Promise((resolve, reject) => {
              reader.onload = () => resolve(reader.result);
              reader.onerror = reject;
              reader.readAsDataURL(fileToProcess);
            });

            // Call serverless OCR function
            const response = await fetch('/api/ocr', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                image: imageBase64
              })
            });

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            newItems.push({
              id: Date.now() + i + Math.random(),
              file: file,
              isPDF: isPDF,
              previewUrl: convertedImageUrl || URL.createObjectURL(file), // Use converted image if available
              preview: convertedImageUrl || null, // Store converted image in preview field
              date: data.date || "",
              category: data.category || "å…¶ä»–",
              description: data.description || file.name,
              amount: data.amount ? parseFloat(data.amount) : 0, // Total after tax
              tax: data.tax ? parseFloat(data.tax) : 0,
              itemName: data.itemName || "",
              specification: data.specification || "",
              unit: data.unit || "",
              quantity: data.quantity || 0,
              unitPrice: data.unitPrice || 0,
              taxRate: data.taxRate || "",
              subtotal: data.subtotal ? parseFloat(data.subtotal) : 0, // Pre-tax amount
              totalWithTax: data.amount ? parseFloat(data.amount) : 0, // Sync with 'amount'
              invoiceNumber: data.invoiceNumber || "",
              buyerName: data.buyerName || "",
              sellerName: data.sellerName || "",
              attachments: [],
              remarks: data.remarks || "",
              reimburser: reimbursementInfo.reimburser || "",
              project: reimbursementInfo.project || ""
            });

            setProcessingQueue(prev => prev.map(item =>
              item.id === queueItem.id ? { ...item, status: 'completed', progress: 100 } : item
            ));

          } catch (error) {
            console.error(`Error processing ${file.name}:`, error);
            setProcessingQueue(prev => prev.map(item =>
              item.id === queueItem.id ? { ...item, status: 'failed', progress: 100 } : item
            ));

            newItems.push({
              id: Date.now() + i + Math.random(),
              file: file,
              isPDF: isPDF,
              previewUrl: URL.createObjectURL(file),
              date: new Date().toISOString().split('T')[0],
              amount: 0,
              tax: 0,
              category: "å…¶ä»–",
              description: `è¯†åˆ«å¤±è´¥ï¼š${file.name} (${error?.message || error})`,
              itemName: "",
              specification: "",
              unit: "",
              quantity: 0,
              unitPrice: 0,
              taxRate: "",
              subtotal: 0,
              totalWithTax: 0,
              invoiceNumber: "",
              buyerName: "",
              sellerName: "",
              attachments: [],
              remarks: "",
              reimburser: reimbursementInfo.reimburser || "",
              project: reimbursementInfo.project || ""
            });
          }
        }

        // Remove default row (id: 1) if it exists and is empty
        const filteredItems = items.filter(item => {
          if (item.id === 1 && !item.date && !item.description && item.amount === 0) {
            return false; // Remove default empty row
          }
          return true;
        });

        setItems([...filteredItems, ...newItems]);
        setIsProcessing(false);
        setTimeout(() => setProcessingQueue([]), 3000);
      };

      // Drag & Drop
      const onDragOver = (e) => { e.preventDefault(); setIsDragging(true); };
      const onDragLeave = () => setIsDragging(false);
      const onDrop = (e) => {
        e.preventDefault();
        setIsDragging(false);
        handleFiles(e.dataTransfer.files);
      };

      // Update Item with Advanced Financial Logic
      const updateItem = (id, field, value) => {
        setItems(prevItems => prevItems.map(item => {
          if (item.id !== id) return item;

          let updatedItem = { ...item, [field]: value };

          // Financial Calculation Logic
          // Fields: subtotal (Before Tax), amount (After Tax), tax (Tax Amount), taxRate (Tax Rate %)

          if (field === 'tax' || field === 'taxRate') {
            // Logic: Input Tax + Rate -> Calc Pre-Tax -> Calc Total
            const tax = parseFloat(updatedItem.tax === '' ? 0 : updatedItem.tax);
            const rateStr = String(updatedItem.taxRate || '').replace('%', '');
            const rate = parseFloat(rateStr === '' ? 0 : rateStr) / 100;

            if (tax && rate) {
              // Inverse Calc: BeforeTax = Tax / Rate
              const preTax = tax / rate;
              updatedItem.subtotal = isFinite(preTax) ? preTax.toFixed(2) : updatedItem.subtotal;

              // Calc Total: AfterTax = PreTax + Tax
              const afterTax = preTax + tax;
              updatedItem.amount = isFinite(afterTax) ? afterTax.toFixed(2) : updatedItem.amount;
            } else if (tax && !rate) {
              // If only tax changed, default behavior: Total = PreTax + Tax (if PreTax exists)
              const preTax = parseFloat(updatedItem.subtotal || 0);
              if (preTax) {
                updatedItem.amount = (preTax + tax).toFixed(2);
              }
            }
          }
          else if (field === 'subtotal') {
            // Logic: Input Pre-Tax -> Calc Total (Pre-Tax + Tax)
            const preTax = parseFloat(updatedItem.subtotal || 0);
            const tax = parseFloat(updatedItem.tax || 0);

            // Only update Total if Pre-Tax is valid. 
            // If Tax is 0, Total = Pre-Tax.
            updatedItem.amount = (preTax + tax).toFixed(2);
          }
          else if (field === 'amount') {
            // Logic: Input changes Total -> Do NOT zero out other fields.
            // Just update the total.
            // (User specifically requested to avoid multiplying by 0 resulting in 0)
            // We treat "Amount (After Tax)" as the source of truth when edited directly.
            updatedItem.totalWithTax = updatedItem.amount; // Sync internal total
          }

          // Ensure sync for internal reducer usage
          updatedItem.totalWithTax = updatedItem.amount;

          return updatedItem;
        }));
      };

      // Handle Image Upload
      const handleImageUpload = (id, field, file) => {
        if (!file) return;
        const url = URL.createObjectURL(file);
        updateItem(id, field, url);
      };

      // Delete Item
      const deleteItem = (id) => {
        setItems(items.filter(item => item.id !== id));
      };


      // Toggle Row Expansion
      const toggleRow = (id) => {
        const newExpanded = new Set(expandedRows);
        if (newExpanded.has(id)) {
          newExpanded.delete(id);
        } else {
          newExpanded.add(id);
        }
        setExpandedRows(newExpanded);
      };


      // Convert blob URL to base64 for ExcelJS
      const blobToBase64 = async (url) => {
        try {
          const response = await fetch(url);
          const blob = await response.blob();
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
          });
        } catch (error) {
          console.error('Blob to base64 conversion error:', error);
          return null;
        }
      };

      // Export to Excel with Images using ExcelJS
      const exportExcel = async () => {
        try {
          if (typeof ExcelJS === 'undefined') {
            alert('Excel å¯¼å‡ºåº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
            return;
          }

          const workbook = new ExcelJS.Workbook();
          const worksheet = workbook.addWorksheet('æŠ¥é”€å•');

          // Get visible columns (excluding actions)
          const visibleCols = columns.filter(c => c.visible && c.id !== 'actions');

          // Add column header row (row 1)
          worksheet.addRow(visibleCols.map(c => c.label));
          worksheet.getRow(1).font = { bold: true };
          worksheet.getRow(1).fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFE3E0D1' }
          };

          // Process each item (starting from row 2)
          for (let i = 0; i < items.length; i++) {
            const item = items[i];
            const rowNum = i + 2; // Data starts at row 2 (after header)


            // Add data row with placeholders for images
            const rowData = visibleCols.map(col => {
              if (col.id === 'preview' || col.id === 'orderImage' || col.id === 'paymentProof') {
                return ''; // Placeholder for images
              } else if (['amount', 'subtotal', 'totalWithTax', 'tax', 'unitPrice'].includes(col.id)) {
                return Number(item[col.id] || 0);
              }
              return item[col.id] || '';
            });
            worksheet.addRow(rowData);

            // Set row height for image columns
            worksheet.getRow(rowNum).height = 60;

            // Add images for each image column
            for (let colIdx = 0; colIdx < visibleCols.length; colIdx++) {
              const col = visibleCols[colIdx];
              const imageUrl = item[col.id] || (col.id === 'preview' ? item.previewUrl : null);

              if ((col.id === 'preview' || col.id === 'orderImage' || col.id === 'paymentProof') && imageUrl) {
                try {
                  const base64 = await blobToBase64(imageUrl);
                  if (base64) {
                    const imageId = workbook.addImage({
                      base64: base64.split(',')[1],
                      extension: 'png',
                    });

                    worksheet.addImage(imageId, {
                      tl: { col: colIdx, row: rowNum - 1 },
                      ext: { width: 80, height: 80 },
                      editAs: 'oneCell'
                    });
                  }
                } catch (error) {
                  console.error(`Image add error for ${col.label}:`, error);
                }
              }
            }
          }

          // Set column widths
          visibleCols.forEach((col, idx) => {
            if (col.id === 'preview' || col.id === 'orderImage' || col.id === 'paymentProof') {
              worksheet.getColumn(idx + 1).width = 15;
            } else if (col.id === 'description') {
              worksheet.getColumn(idx + 1).width = 30;
            } else if (col.id === 'amount' || col.id === 'subtotal') {
              worksheet.getColumn(idx + 1).width = 12;
            } else {
              worksheet.getColumn(idx + 1).width = 15;
            }
          });

          // Add reimbursement info at the bottom
          const lastDataRow = items.length + 1;
          worksheet.addRow([]); // Empty row

          const infoStartRow = lastDataRow + 2;
          worksheet.addRow(['æŠ¥é”€å•ä¿¡æ¯']);
          worksheet.getRow(infoStartRow).font = { bold: true, size: 14 };
          worksheet.mergeCells(`A${infoStartRow}:D${infoStartRow}`);

          worksheet.addRow(['æŠ¥é”€äºº:', reimbursementInfo.reimburser || 'æœªå¡«å†™']);
          worksheet.addRow(['æ‰€å±é¡¹ç›®:', reimbursementInfo.project || 'æœªå¡«å†™']);
          worksheet.addRow(['æŠ¥é”€æ—¥æœŸ:', reimbursementInfo.reimbursementDate || new Date().toLocaleDateString('zh-CN')]);
          worksheet.addRow(['æ”¶æ¬¾ä¿¡æ¯:', reimbursementInfo.paymentInfo || 'æœªå¡«å†™']);


          // Generate and download
          const buffer = await workbook.xlsx.writeBuffer();
          const blob = new Blob([buffer], {
            type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `æŠ¥é”€å•_${reimbursementInfo.reimburser || 'Export'}_${new Date().toISOString().split('T')[0]}.xlsx`;
          a.click();
          URL.revokeObjectURL(url);
        } catch (error) {
          console.error('Excel export failed:', error);
          alert('Excel å¯¼å‡ºå¤±è´¥: ' + error.message);
        }
      };


      // Helper to compress images for PDF export - ROBUST BASE64 VERSION
      const resizeImage = async (url) => {
        if (!url) return null;
        console.log('ğŸ–¼ï¸ Starting resizeImage for:', url.substring(0, 60));
        try {
          // Step 1: Convert to Base64 FIRST (this is our safety net)
          let base64Data = null;
          if (url.startsWith('data:image')) {
            // Already Base64, use directly
            base64Data = url;
            console.log('âœ… Already Base64 format');
          } else if (url.startsWith('blob:')) {
            // Convert Blob URL to Base64 using fetch + FileReader
            console.log('ğŸ”„ Converting Blob URL to Base64...');
            const response = await fetch(url);
            const blob = await response.blob();
            base64Data = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onloadend = () => resolve(reader.result);
              reader.onerror = reject;
              reader.readAsDataURL(blob);
            });
            console.log('âœ… Base64 conversion successful, length:', base64Data.length);
          } else {
            // Unknown format, return null
            console.warn('âš ï¸ Unknown URL format:', url.substring(0, 60));
            return null;
          }
          // Step 2: Try to optimize/resize (with timeout protection)
          const optimized = await Promise.race([
            // Optimization attempt
            new Promise((resolve) => {
              const img = new Image();
              img.onload = () => {
                try {
                  const canvas = document.createElement('canvas');
                  const ctx = canvas.getContext('2d');
                  const maxDim = 800;
                  let width = img.width;
                  let height = img.height;
                  // Calculate new dimensions
                  if (width > height && width > maxDim) {
                    height = Math.round(height * (maxDim / width));
                    width = maxDim;
                  } else if (height >= width && height > maxDim) {
                    width = Math.round(width * (maxDim / height));
                    height = maxDim;
                  }
                  canvas.width = width;
                  canvas.height = height;
                  ctx.drawImage(img, 0, 0, width, height);
                  const resized = canvas.toDataURL('image/jpeg', 0.85);
                  console.log('âœ… Image optimized:', width + 'x' + height, 'size:', resized.length);
                  resolve(resized);
                } catch (err) {
                  console.error('âŒ Canvas error:', err);
                  resolve(base64Data); // Fallback to original Base64
                }
              };
              img.onerror = (e) => {
                console.error('âŒ Image load error:', e);
                resolve(base64Data); // Fallback to original Base64
              };
              img.src = base64Data; // Use Base64, not Blob URL!
            }),
            // 2-second timeout
            new Promise((resolve) => {
              setTimeout(() => {
                console.warn('â±ï¸ Resize timeout, using original Base64');
                resolve(base64Data);
              }, 2000);
            })
          ]);
          return optimized;
        } catch (error) {
          console.error('âŒ Fatal error in resizeImage:', error);
          return null;
        }
      };

      const exportPDF = async () => {
        try {
          if (typeof html2pdf === 'undefined') {
            alert('PDF å¯¼å‡ºåº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
            return;
          }

          setIsProcessing(true);

          // 1. Optimize images specifically for PDF export
          const optimizedItems = await Promise.all(items.map(async (item) => {
            const newItem = { ...item };

            // Compress all image fields
            const imageFields = ['previewUrl', 'orderImage', 'paymentProof'];
            for (const field of imageFields) {
              if (newItem[field] || (field === 'preview' && newItem.previewUrl)) {
                const src = newItem[field] || newItem.previewUrl;
                if (src && src.startsWith('blob:')) {
                  newItem[field] = await resizeImage(src);
                }
              }
            }
            return newItem;
          }));

          setPdfItems(optimizedItems);

          // Give React time to render the optimized items into the hidden DOM
          await new Promise(resolve => setTimeout(resolve, 800));

          // Get the PDF preview element
          const element = document.getElementById('pdf-preview-content');
          if (!element) {
            alert('PDF é¢„è§ˆå†…å®¹æœªæ‰¾åˆ°');
            setIsProcessing(false);
            return;
          }

          // Configure pdf options - optimized for speed
          const opt = {
            margin: 5,
            filename: `æŠ¥é”€å•_${reimbursementInfo.reimburser || 'Export'}_${new Date().toISOString().split('T')[0]}.pdf`,
            image: { type: 'jpeg', quality: 0.90 },
            html2canvas: {
              scale: 1.5,
              useCORS: true,
              allowTaint: true,
              logging: false
            },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
          };

          // Generate and download PDF
          console.log('Starting html2pdf generation...');
          await html2pdf().set(opt).from(element).save();
          console.log('html2pdf finished');

        } catch (error) {
          console.error('PDF export failed:', error);
          alert('PDF å¯¼å‡ºå¤±è´¥: ' + error.message);
        } finally {
          console.log('Export process finished (finally block)');
          setIsProcessing(false);
          setPdfItems(null); // Clear optimized items to free memory
        }
      };

      // NEW: Browser-native print-based PDF export  
      const exportPDF_Print = () => {
        try {
          console.log('ğŸ–¨ï¸ Starting browser-native PDF export...');

          const visibleColumns = columns.filter(c => c.visible && c.id !== 'actions');
          const totalAmount = items.reduce((sum, item) => sum + Number(item.amount || 0), 0);
          const filename = 'æŠ¥é”€å•_' + (reimbursementInfo.reimburser || 'Export') + '_' + new Date().toISOString().split('T')[0];

          // Build HTML rows
          let tableRows = '';
          items.forEach(item => {
            tableRows += '<tr>';
            visibleColumns.forEach(col => {
              if (col.id === 'preview' || col.id === 'orderImage' || col.id === 'paymentProof') {
                const src = item[col.id] || (col.id === 'preview' && item.previewUrl);
                tableRows += src ? '<td><img src="' + src + '" alt="' + col.label + '" /></td>' : '<td></td>';
              } else if (['amount', 'subtotal', 'totalWithTax', 'tax', 'unitPrice'].includes(col.id)) {
                tableRows += '<td>Â¥' + Number(item[col.id] || 0).toFixed(2) + '</td>';
              } else {
                tableRows += '<td>' + (item[col.id] || '') + '</td>';
              }
            });
            tableRows += '</tr>';
          });

          // Build HTML (using string concatenation to avoid template literal issues)
          const printHTML = '<!DOCTYPE html>' +
            '<html lang="zh-CN"><head><meta charset="UTF-8"><title>' + filename + '</title>' +
            '<style>' +
            '* { margin: 0; padding: 0; box-sizing: border-box; }' +
            '@page { size: A4 landscape; margin: 10mm; }' +
            'body { font-family: "Noto Sans SC", "Microsoft YaHei", sans-serif; font-size: 9px; line-height: 1.4; color: #000; background: #fff; }' +
            '.container { width: 277mm; margin: 0 auto; padding: 5mm; }' +
            '.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }' +
            '.header img { height: 32px; }' +
            '.header h1 { flex: 1; text-align: center; font-size: 18px; font-weight: bold; }' +
            '.info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 6px; font-size: 10px; }' +
            '.payment-info { margin-bottom: 6px; font-size: 10px; }' +
            'table { width: 100%; border-collapse: collapse; margin-bottom: 8px; }' +
            'th, td { border: 1px solid #999; padding: 4px; text-align: left; vertical-align: middle; }' +
            'th { background: #f0f0f0; font-weight: bold; }' +
            'td img { width: 64px; height: 64px; object-fit: contain; display: block; margin: 0 auto; }' +
            'tfoot td { background: #f9f9f9; font-weight: bold; text-align: right; }' +
            '.notes { margin-top: 16px; font-size: 11px; }' +
            '.notes p:last-child { min-height: 30px; border-bottom: 1px solid #ccc; }' +
            '.signatures { display: flex; justify-content: space-between; margin-top: 24px; font-size: 11px; }' +
            '.signatures span { display: inline-block; min-width: 100px; border-bottom: 1px solid #ccc; }' +
            '@media print { .container { width: 100%; padding: 0; } @page { margin: 10mm; } }' +
            '</style></head><body><div class="container">' +
            '<div class="header"><img src="logo_text.png" alt="Kairos Logo" /><h1>æŠ¥é”€å•</h1><img src="logo_graph.png" alt="Kairos Graph" /></div>' +
            '<div class="info-grid">' +
            '<p><strong>æŠ¥é”€äºº:</strong> ' + (reimbursementInfo.reimburser || 'æœªå¡«å†™') + '</p>' +
            '<p><strong>æ‰€å±é¡¹ç›®:</strong> ' + (reimbursementInfo.project || 'æœªå¡«å†™') + '</p>' +
            '<p><strong>æŠ¥é”€æ—¥æœŸ:</strong> ' + (reimbursementInfo.reimbursementDate || new Date().toLocaleDateString('zh-CN')) + '</p>' +
            '</div><div class="payment-info"><p><strong>æ”¶æ¬¾ä¿¡æ¯:</strong> ' + (reimbursementInfo.paymentInfo || 'æœªå¡«å†™') + '</p></div>' +
            '<table><thead><tr>' + visibleColumns.map(col => '<th>' + col.label + '</th>').join('') + '</tr></thead>' +
            '<tbody>' + tableRows + '</tbody>' +
            '<tfoot><tr><td colspan="' + (visibleColumns.length - 1) + '">æ€»è®¡:</td><td>Â¥' + totalAmount.toFixed(2) + '</td></tr></tfoot>' +
            '</table><div class="notes"><p><strong>å¤‡æ³¨:</strong></p><p></p></div>' +
            '<div class="signatures"><p><strong>æŠ¥é”€äººç­¾å­—:</strong> <span></span></p><p><strong>å®¡æ ¸äººç­¾å­—:</strong> <span></span></p></div>' +
            '</div><script>window.onload = function() { console.log("Print window loaded"); setTimeout(function() { window.print(); }, 500); };</script>
</body>

</html>';

const printWindow = window.open('', '_blank', 'width=1200,height=800');
if (!printWindow) {
alert('æ— æ³•æ‰“å¼€æ‰“å°çª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å¼¹çª—è®¾ç½®');
return;
}

printWindow.document.write(printHTML);
printWindow.document.close();
console.log('âœ… Print window opened');

} catch (error) {
console.error('âŒ Print export failed:', error);
alert('PDF å¯¼å‡ºå¤±è´¥: ' + error.message);
}
};

try {
console.log('ğŸ–¨ï¸ Starting browser-native PDF export...');

const visibleColumns = columns.filter(c => c.visible && c.id !== 'actions');
const totalAmount = items.reduce((sum, item) => sum + Number(item.amount || 0), 0);
const filename = `æŠ¥é”€å•_${reimbursementInfo.reimburser || 'Export'}_${new Date().toISOString().split('T')[0]}`;

const printHTML = `
<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <title>${filename}</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    @page {
      size: A4 landscape;
      margin: 10mm;
    }

    body {
      font-family: 'Noto Sans SC', 'Microsoft YaHei', sans-serif;
      font-size: 9px;
      line-height: 1.4;
      color: #000;
      background: #fff;
    }

    .container {
      width: 277mm;
      margin: 0 auto;
      padding: 5mm;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .header img {
      height: 32px;
    }

    .header h1 {
      flex: 1;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 6px;
      font-size: 10px;
    }

    .payment-info {
      margin-bottom: 6px;
      font-size: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 8px;
    }

    th,
    td {
      border: 1px solid #999;
      padding: 4px;
      text-align: left;
      vertical-align: middle;
    }

    th {
      background: #f0f0f0;
      font-weight: bold;
    }

    td img {
      width: 64px;
      height: 64px;
      object-fit: contain;
      display: block;
      margin: 0 auto;
    }

    tfoot td {
      background: #f9f9f9;
      font-weight: bold;
      text-align: right;
    }

    .notes {
      margin-top: 16px;
      font-size: 11px;
    }

    .notes p:last-child {
      min-height: 30px;
      border-bottom: 1px solid #ccc;
    }

    .signatures {
      display: flex;
      justify-content: space-between;
      margin-top: 24px;
      font-size: 11px;
    }

    .signatures span {
      display: inline-block;
      min-width: 100px;
      border-bottom: 1px solid #ccc;
    }

    @media print {
      .container {
        width: 100%;
        padding: 0;
      }

      @page {
        margin: 10mm;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <img src="logo_text.png" alt="Kairos Logo" />
      <h1>æŠ¥é”€å•</h1>
      <img src="logo_graph.png" alt="Kairos Graph" />
    </div>
    <div class="info-grid">
      <p><strong>æŠ¥é”€äºº:</strong> ${reimbursementInfo.reimburser || 'æœªå¡«å†™'}</p>
      <p><strong>æ‰€å±é¡¹ç›®:</strong> ${reimbursementInfo.project || 'æœªå¡«å†™'}</p>
      <p><strong>æŠ¥é”€æ—¥æœŸ:</strong> ${reimbursementInfo.reimbursementDate || new Date().toLocaleDateString('zh-CN')}</p>
    </div>
    <div class="payment-info">
      <p><strong>æ”¶æ¬¾ä¿¡æ¯:</strong> ${reimbursementInfo.paymentInfo || 'æœªå¡«å†™'}</p>
    </div>
    <table>
      <thead>
        <tr>${visibleColumns.map(col => `<th>${col.label}</th>`).join('')}</tr>
      </thead>
      <tbody>
        ${items.map(item => `
        <tr>
          ${visibleColumns.map(col => {
          if (col.id === 'preview' || col.id === 'orderImage' || col.id === 'paymentProof') {
          const src = item[col.id] || (col.id === 'preview' && item.previewUrl);
          return src ? `<td><img src="${src}" alt="${col.label}" /></td>` : '<td></td>';
          } else if (['amount', 'subtotal', 'totalWithTax', 'tax', 'unitPrice'].includes(col.id)) {
          return `<td>Â¥${Number(item[col.id] || 0).toFixed(2)}</td>`;
          } else {
          return `<td>${item[col.id] || ''}</td>`;
          }
          }).join('')}
        </tr>
        `).join('')}
      </tbody>
      <tfoot>
        <tr>
          <td colspan="${visibleColumns.length - 1}">æ€»è®¡:</td>
          <td>Â¥${totalAmount.toFixed(2)}</td>
        </tr>
      </tfoot>
    </table>
    <div class="notes">
      <p><strong>å¤‡æ³¨:</strong></p>
      <p></p>
    </div>
    <div class="signatures">
      <p><strong>æŠ¥é”€äººç­¾å­—:</strong> <span></span></p>
      <p><strong>å®¡æ ¸äººç­¾å­—:</strong> <span></span></p>
    </div>
  </div>
  <script>
          window.onload = function () {
            console.log('âœ… Print window loaded');
            setTimeout(() => window.print(), 500);
          };
  </script>
</body>

</html>`;

const printWindow = window.open('', '_blank', 'width=1200,height=800');
if (!printWindow) {
alert('æ— æ³•æ‰“å¼€æ‰“å°çª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å¼¹çª—è®¾ç½®');
return;
}

printWindow.document.write(printHTML);
printWindow.document.close();
console.log('âœ… Print window opened');

} catch (error) {
console.error('âŒ Print export failed:', error);
alert('PDF å¯¼å‡ºå¤±è´¥: ' + error.message);
}
};


const addNewRow = () => {
const newItem = {
id: Date.now(),
file: null,
isPDF: false,
previewUrl: null,
date: new Date().toISOString().split('T')[0],
amount: 0,
tax: 0,
category: "å…¶ä»–",
description: "",
itemName: "",
specification: "",
unit: "",
quantity: 0,
unitPrice: 0,
taxRate: "",
subtotal: 0,
totalWithTax: 0,
invoiceNumber: "",
buyerName: "",
sellerName: "",
attachments: [],
remarks: "",
reimburser: reimbursementInfo.reimburser || "",
project: reimbursementInfo.project || ""
};
setItems([...items, newItem]);
};

// Use amount for total calculation
const totalAmount = items.reduce((sum, item) => sum + Number(item.amount || 0), 0);

// Reusable PDF Content Component
const PDFContent = ({ items, reimbursementInfo, columns }) => {
// Use 'amount' for total calculation to match visible column
const pdfTotalAmount = items.reduce((sum, item) => sum + Number(item.amount || 0), 0);
// Filter columns based on visibility toggle (respect the 'visible' property)
const visibleColumns = columns.filter(c => c.visible && c.id !== 'actions');

// Use 275mm width to ensure it fits within A4 Landscape (297mm) minus margins
return (
<div id="pdf-preview-content" className="p-4 bg-white text-black w-[275mm] min-h-[210mm] mx-auto text-[9px] relative">
  <div className="flex items-center justify-between mb-3">
    <img src="logo_text.png" alt="Kairos Studio Logo" className="h-8" />
    <h1 className="text-lg font-bold flex-1 text-center">æŠ¥é”€å•</h1>
    <img src="logo_graph.png" alt="Kairos Graph Logo" className="h-8" />
  </div>

  <div className="mb-2 grid grid-cols-3 gap-2 text-[10px]">
    <p><strong>æŠ¥é”€äºº:</strong> {reimbursementInfo.reimburser || 'æœªå¡«å†™'}</p>
    <p><strong>æ‰€å±é¡¹ç›®:</strong> {reimbursementInfo.project || 'æœªå¡«å†™'}</p>
    <p><strong>æŠ¥é”€æ—¥æœŸ:</strong> {reimbursementInfo.reimbursementDate || new Date().toLocaleDateString('zh-CN')}</p>
  </div>
  <div className="mb-2 text-[10px]">
    <p><strong>æ”¶æ¬¾ä¿¡æ¯:</strong> {reimbursementInfo.paymentInfo || 'æœªå¡«å†™'}</p>
  </div>

  <table className="w-full border-collapse mb-2 table-auto">
    <thead>
      <tr>
        {visibleColumns.map(col => (
        <th key={col.id} className="border border-gray-400 p-1 text-left bg-gray-100">{col.label}</th>
        ))}
      </tr>
    </thead>
    <tbody>
      {items.map(item => (
      <tr key={item.id}>
        {visibleColumns.map(col => (
        <td key={col.id} className="border border-gray-400 p-1">
          {col.id === 'preview' || col.id === 'orderImage' || col.id === 'paymentProof' ? (
          item[col.id] || (col.id === 'preview' && item.previewUrl) ? (
          <img src={item[col.id] || item.previewUrl} className="w-16 h-16 object-contain mx-auto" alt={col.label}
            crossOrigin="anonymous" />
          ) : ''
          ) : ['amount', 'subtotal', 'totalWithTax', 'tax', 'unitPrice'].includes(col.id)
          ? `Â¥${Number(item[col.id] || 0).toFixed(2)}`
          : (item[col.id] || '')}
        </td>
        ))}
      </tr>
      ))}
    </tbody>
    <tfoot>
      <tr>
        <td colSpan={visibleColumns.length - 1} className="border border-gray-400 p-1 text-right font-bold bg-gray-50">
          æ€»è®¡:</td>
        <td className="border border-gray-400 p-1 text-right font-bold bg-gray-50">Â¥{pdfTotalAmount.toFixed(2)}</td>
      </tr>
    </tfoot>
  </table>

  <div className="text-xs mt-6">
    <p><strong>å¤‡æ³¨:</strong></p>
    <p className="min-h-[30px] border-b border-gray-300"></p>
  </div>

  <div className="flex justify-between mt-8 text-xs">
    <p><strong>æŠ¥é”€äººç­¾å­—:</strong> <span className="min-w-[100px] inline-block border-b border-gray-300"></span></p>
    <p><strong>å®¡æ ¸äººç­¾å­—:</strong> <span className="min-w-[100px] inline-block border-b border-gray-300"></span></p>
  </div>
</div>
);
};

// Main App return
return (
<div className="min-h-screen bg-gradient-to-br from-[#0a0a0a] via-[#1a1a1a] to-[#0a0a0a]">

  {/* OCR Confirmation Dialog */}
  {ocrConfirmation.show && (
  <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6" onClick={()=>
    setOcrConfirmation({ show: false, itemId: null, file: null, imageUrl: null })}>
    <div className="bg-[#1a1a1a] rounded-xl p-8 max-w-md w-full border border-[#2a2a2a]" onClick={(e)=>
      e.stopPropagation()}>
      <h3 className="text-xl font-bold mb-2 font-cn text-center">æ˜¯å¦ä½¿ç”¨è‡ªåŠ¨è¯†åˆ«ï¼Ÿ</h3>
      <p className="text-gray-500 text-xs text-center mb-6">Powered by Qwen</p>
      {ocrConfirmation.imageUrl && (
      <div className="mb-6 flex justify-center">
        <img src={ocrConfirmation.imageUrl} alt="Preview" className="max-h-48 rounded border border-[#2a2a2a]" />
      </div>
      )}
      <div className="flex gap-4">
        <button onClick={async ()=> {
          const { itemId, file, imageUrl } = ocrConfirmation;
          setOcrConfirmation({ show: false, itemId: null, file: null, imageUrl: null });
          updateItem(itemId, 'previewUrl', imageUrl);
          updateItem(itemId, 'file', file);
          setIsProcessing(true);
          try {
          const reader = new FileReader();
          const imageBase64 = await new Promise((resolve, reject) => {
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
          });
          const response = await fetch('/api/ocr', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image: imageBase64 })
          });
          if (!response.ok) throw new Error('OCR failed');
          const data = await response.json();

          if (data) {
          Object.entries(data).forEach(([key, value]) => {
          if (value !== null && value !== undefined && value !== '') {
          updateItem(itemId, key, value);
          }
          });
          }
          } catch (error) {
          console.error('OCR Error:', error);
          alert('OCRè¯†åˆ«å¤±è´¥ï¼š' + error.message);
          } finally {
          setIsProcessing(false);
          }
          }} className="flex-1 bg-yellow-500 hover:bg-yellow-600 text-black py-3 rounded-lg font-cn font-semibold
          transition">æ˜¯</button>
        <button onClick={()=> {
          const { itemId, imageUrl, file } = ocrConfirmation;
          updateItem(itemId, 'previewUrl', imageUrl);
          updateItem(itemId, 'file', file);
          setOcrConfirmation({ show: false, itemId: null, file: null, imageUrl: null });
          }} className="flex-1 bg-[#2a2a2a] hover:bg-[#3a3a3a] text-gray-300 py-3 rounded-lg font-cn
          transition">å¦</button>
      </div>
    </div>
  </div>
  )}

  {/* Tutorial Welcome Card */}
  {showTutorial && (
  <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div className="card-modern rounded-2xl p-8 max-w-2xl w-full relative animate-fade-in">
      <button onClick={closeTutorial} className="absolute top-4 right-4 text-gray-400 hover:text-white transition">
        <X size={24} />
      </button>

      <div className="text-center mb-6">
        <div className="w-40 h-15 items-center justify-center mx-auto mb-4 overflow-hidden">
          <img src="logo.png" alt="Kairos Studio" className="w-full h-full object-contain" />
        </div>
        <h2 className="text-2xl font-bold mb-2 font-cn">æ¬¢è¿ä½¿ç”¨ Kairos Studio æŠ¥é”€å•æ•´ç†å·¥å…·</h2>
        <p className="text-gray-400 text-sm font-en">QUICK START GUIDE</p>
      </div>

      <div className="space-y-4 mb-6">
        <div className="flex gap-4 items-start">
          <div className="w-8 h-8 bg-yellow-400/10 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
            <span className="text-yellow-400 font-bold">1</span>
          </div>
          <div>
            <h3 className="font-semibold mb-1 font-cn">å¡«å†™æŠ¥é”€ä¿¡æ¯</h3>
            <p className="text-sm text-gray-400">è¾“å…¥æŠ¥é”€äººã€æ‰€å±é¡¹ç›®ã€æŠ¥é”€æ—¥æœŸå’Œæ”¶æ¬¾ä¿¡æ¯</p>
          </div>
        </div>

        <div className="flex gap-4 items-start">
          <div className="w-8 h-8 bg-yellow-400/10 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
            <span className="text-yellow-400 font-bold">2</span>
          </div>
          <div>
            <h3 className="font-semibold mb-1 font-cn">ä¸Šä¼ å‘ç¥¨</h3>
            <p className="text-sm text-gray-400">æ”¯æŒ JPGã€PNGã€PDF æ ¼å¼ï¼ŒOCR è‡ªåŠ¨è¯†åˆ«å‘ç¥¨ä¿¡æ¯</p>
          </div>
        </div>

        <div className="flex gap-4 items-start">
          <div className="w-8 h-8 bg-yellow-400/10 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
            <span className="text-yellow-400 font-bold">3</span>
          </div>
          <div>
            <h3 className="font-semibold mb-1 font-cn">è¡¥å……å›¾ç‰‡</h3>
            <p className="text-sm text-gray-400">æ‹–æ‹½ä¸Šä¼ è®¢å•å›¾å’Œæ”¯ä»˜å‡­è¯ï¼ˆå¯é€‰ï¼‰</p>
          </div>
        </div>

        <div className="flex gap-4 items-start">
          <div className="w-8 h-8 bg-yellow-400/10 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
            <span className="text-yellow-400 font-bold">4</span>
          </div>
          <div>
            <h3 className="font-semibold mb-1 font-cn">å¯¼å‡ºæŠ¥é”€å•</h3>
            <p className="text-sm text-gray-400">ä¸€é”®å¯¼å‡º Excel æˆ– PDF æ ¼å¼ï¼Œå›¾ç‰‡è‡ªåŠ¨åµŒå…¥</p>
          </div>
        </div>
      </div>

      <button onClick={closeTutorial} className="w-full btn-primary py-3 rounded-lg font-semibold font-cn">
        å¼€å§‹ä½¿ç”¨
      </button>
    </div>
  </div>
  )}
  {/* Hidden PDF Content - Always in DOM for export */}
  <div style={{ position: 'absolute' , left: '-9999px' , top: '0' }}>
    <PDFContent items={pdfItems || items} reimbursementInfo={reimbursementInfo} columns={columns} />
  </div>

  {/* Visible UI */}
  <header className="border-b border-[#2a2a2a] px-8 py-6">
    <div className="flex items-center justify-between">
      <div className="flex items-center gap-4">
        <img src="logo.png" alt="Logo" className="h-10" />
      </div>
      <div className="flex items-center gap-2 text-xs text-gray-500 font-en">
        <div className="w-2 h-2 rounded-full bg-green-500"></div>
        <span>LOCAL / OFFLINE</span>
      </div>
    </div>
  </header>

  {/* Main Content */}
  <main className="max-w-7xl mx-auto p-6 space-y-6">

    {/* Reimbursement Info & Upload */}
    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">

      {/* Upload Zone */}
      <div className={`upload-zone rounded-xl p-8 flex flex-col items-center justify-center text-center cursor-pointer
        ${isDragging ? 'drag-active' : '' }`} onDragOver={onDragOver} onDragLeave={onDragLeave} onDrop={onDrop}
        onClick={()=> document.getElementById('fileInput').click()}
        >
        <input type="file" id="fileInput" multiple className="hidden" onChange={(e)=> handleFiles(e.target.files)} />
        <div className="w-14 h-14 bg-[#1a1a1a] rounded-full flex items-center justify-center mb-4">
          {isProcessing ?
          <RefreshCw className="animate-spin text-yellow-400" size={28} /> :
          <Upload className="text-yellow-400" size={28} />}
        </div>
        <p className="text-sm font-semibold mb-2 font-cn">ä¸Šä¼ å‘ç¥¨</p>
        <p className="text-xs text-gray-400 mb-1 font-cn">è‡ªåŠ¨è¯†åˆ«æ–‡å­—å†…å®¹å¡«å……</p>
        <p className="text-xs text-gray-500 font-en">æ”¯æŒæ ¼å¼ï¼šJPGã€PNGã€PDF</p>
      </div>

      {/* Reimbursement Info */}
      <div className="lg:col-span-2 card-modern rounded-xl p-6">
        <div className="flex items-center gap-2 mb-4 pb-3 border-b border-[#2a2a2a]">
          <Settings size={18} className="text-yellow-400" />
          <span className="font-semibold text-sm font-cn">æŠ¥é”€å•ä¿¡æ¯</span>
          <span className="text-xs text-gray-500 font-en">REIMBURSEMENT INFO</span>
        </div>
        <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div>
            <label className="text-xs text-gray-500 mb-1.5 block font-cn">æŠ¥é”€äºº</label>
            <input type="text" className="w-full px-3 py-2.5 input-modern rounded-lg text-sm" placeholder="ä¾‹ï¼šé»„é¸Ÿ"
              value={reimbursementInfo.reimburser} onChange={e=> setReimbursementInfo({ ...reimbursementInfo,
            reimburser: e.target.value })}
            />
          </div>
          <div>
            <label className="text-xs text-gray-500 mb-1.5 block font-cn">æ‰€å±é¡¹ç›®</label>
            <input type="text" className="w-full px-3 py-2.5 input-modern rounded-lg text-sm" placeholder="ä¾‹ï¼š11-12 æœˆæŠ¥é”€"
              value={reimbursementInfo.project} onChange={e=> setReimbursementInfo({ ...reimbursementInfo, project:
            e.target.value })}
            />
          </div>
          <div>
            <label className="text-xs text-gray-500 mb-1.5 block font-cn">æŠ¥é”€æ—¥æœŸ</label>
            <input type="date" className="w-full px-3 py-2.5 input-modern rounded-lg text-sm"
              value={reimbursementInfo.reimbursementDate} onChange={e=> setReimbursementInfo({ ...reimbursementInfo,
            reimbursementDate: e.target.value })}
            />
          </div>
        </div>
        <div className="mt-4">
          <label className="text-xs text-gray-500 mb-1.5 block font-cn">æ”¶æ¬¾ä¿¡æ¯</label>
          <input type="text" className="w-full px-3 py-2.5 input-modern rounded-lg text-sm" placeholder="è¯·è¾“å…¥é“¶è¡Œå¡å·æˆ–æ”¶æ¬¾è´¦æˆ·ä¿¡æ¯"
            value={reimbursementInfo.paymentInfo} onChange={e=> setReimbursementInfo({ ...reimbursementInfo,
          paymentInfo: e.target.value })}
          />
        </div>
      </div>
    </div>

    {/* Processing Queue */}
    {processingQueue.length > 0 && (
    <div className="card-modern rounded-xl p-5">
      <h3 className="text-sm font-semibold mb-4 font-cn">å¤„ç†è¿›åº¦</h3>
      <div className="space-y-3">
        {processingQueue.map(item => (
        <div key={item.id} className="space-y-1.5">
          <div className="flex justify-between text-xs">
            <span className="text-gray-400 font-en">{item.name}</span>
            <span className={`font-semibold ${item.status==='completed' ? 'text-green-400' : item.status==='failed'
              ? 'text-red-400' : 'text-yellow-400' } font-cn`}>
              {item.status === 'waiting' && 'ç­‰å¾…ä¸­'}
              {item.status === 'processing' && 'å¤„ç†ä¸­...'}
              {item.status === 'completed' && 'å®Œæˆ'}
              {item.status === 'failed' && 'å¤±è´¥'}
            </span>
          </div>
          <div className="progress-bar h-1.5">
            <div className={`progress-fill ${item.status==='failed' ? 'bg-red-500' : '' }`} style={{ width:
              `${item.progress}%` }} />
          </div>
        </div>
        ))}
      </div>
    </div>
    )}

    {/* Items Table */}
    {items.length > 0 && (
    <div className="card-modern rounded-xl overflow-hidden">
      <div className="overflow-x-auto">
        <table className="table-modern">
          <thead>
            <tr>
              {columns.filter(c => c.visible).map(col => (
              <th key={col.id} className="font-cn whitespace-nowrap">
                {col.label}
              </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {items.map(item => (
            <React.Fragment key={item.id}>
              <tr>
                {columns.filter(c => c.visible).map(col => (
                <td key={col.id} className={col.width || '' }>
                  {/* Render Content Based on Column ID */}
                  {col.id === 'preview' && (
                  !item.previewUrl ? (
                  <label
                    className="w-12 h-12 bg-[#1a1a1a] rounded flex items-center justify-center cursor-pointer hover:bg-[#2a2a2a] border border-dashed border-gray-700"
                    onDragOver={(e)=> { e.preventDefault(); e.stopPropagation(); }}
                    onDrop={async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    let file = e.dataTransfer.files[0];
                    if (file) {
                    if (file.type === 'application/pdf') {
                    file = await convertPDFToImage(file);
                    }
                    if (file && file.type.startsWith('image/')) {
                    const url = URL.createObjectURL(file);
                    setOcrConfirmation({ show: true, itemId: item.id, file: file, imageUrl: url });
                    }
                    }
                    }}
                    >
                    <Upload size={16} className="text-gray-500" />
                    <input type="file" className="hidden" accept="image/*,application/pdf" onChange={async (e)=> {
                    let file = e.target.files[0];
                    if (file) {
                    if (file.type === 'application/pdf') {
                    file = await convertPDFToImage(file);
                    }
                    if (file && file.type.startsWith('image/')) {
                    const url = URL.createObjectURL(file);
                    setOcrConfirmation({ show: true, itemId: item.id, file: file, imageUrl: url });
                    }
                    }
                    }} />
                  </label>
                  ) : (
                  <div className="relative group w-12 h-12">
                    <img src={item.previewUrl}
                      className="w-12 h-12 object-cover rounded cursor-pointer border border-gray-700" onClick={()=>
                    setPdfPreviewUrl(item.previewUrl)} alt="invoice" />
                    <button onClick={(e)=> { e.stopPropagation(); updateItem(item.id, 'previewUrl', null);
                      updateItem(item.id, 'file', null); }}
                      className="absolute -top-1 -right-1 bg-black/80 text-white rounded-full p-0.5 opacity-0
                      group-hover:opacity-100 transition"
                      >
                      <X size={10} />
                    </button>
                  </div>
                  )
                  )}

                  {col.id === 'orderImage' && (
                  !item.orderImage ? (
                  <label
                    className="w-12 h-12 bg-[#1a1a1a] rounded flex items-center justify-center cursor-pointer hover:bg-[#2a2a2a] border border-dashed border-gray-700"
                    onDragOver={(e)=> { e.preventDefault(); e.stopPropagation(); }}
                    onDrop={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const file = e.dataTransfer.files[0];
                    if (file && file.type.startsWith('image/')) {
                    handleImageUpload(item.id, 'orderImage', file);
                    }
                    }}
                    >
                    <Upload size={16} className="text-gray-500" />
                    <input type="file" className="hidden" accept="image/*" onChange={(e)=> handleImageUpload(item.id,
                    'orderImage', e.target.files[0])} />
                  </label>
                  ) : (
                  <div className="relative group w-12 h-12">
                    <img src={item.orderImage}
                      className="w-12 h-12 object-cover rounded cursor-pointer border border-gray-700" onClick={()=>
                    setPdfPreviewUrl(item.orderImage)} alt="order" />
                    <button onClick={(e)=> { e.stopPropagation(); updateItem(item.id, 'orderImage', null); }}
                      className="absolute -top-1 -right-1 bg-black/80 text-white rounded-full p-0.5 opacity-0
                      group-hover:opacity-100 transition"
                      >
                      <X size={10} />
                    </button>
                  </div>
                  )
                  )}

                  {col.id === 'paymentProof' && (
                  !item.paymentProof ? (
                  <label
                    className="w-12 h-12 bg-[#1a1a1a] rounded flex items-center justify-center cursor-pointer hover:bg-[#2a2a2a] border border-dashed border-gray-700"
                    onDragOver={(e)=> { e.preventDefault(); e.stopPropagation(); }}
                    onDrop={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const file = e.dataTransfer.files[0];
                    if (file && file.type.startsWith('image/')) {
                    handleImageUpload(item.id, 'paymentProof', file);
                    }
                    }}
                    >
                    <Upload size={16} className="text-gray-500" />
                    <input type="file" className="hidden" accept="image/*" onChange={(e)=> handleImageUpload(item.id,
                    'paymentProof', e.target.files[0])} />
                  </label>
                  ) : (
                  <div className="relative group w-12 h-12">
                    <img src={item.paymentProof}
                      className="w-12 h-12 object-cover rounded cursor-pointer border border-gray-700" onClick={()=>
                    setPdfPreviewUrl(item.paymentProof)} alt="payment" />
                    <button onClick={(e)=> { e.stopPropagation(); updateItem(item.id, 'paymentProof', null); }}
                      className="absolute -top-1 -right-1 bg-black/80 text-white rounded-full p-0.5 opacity-0
                      group-hover:opacity-100 transition"
                      >
                      <X size={10} />
                    </button>
                  </div>
                  )
                  )}

                  {col.id === 'date' && (
                  <input type="date" className="input-modern px-3 py-1.5 rounded text-sm w-full" value={item.date}
                    onChange={e=> updateItem(item.id, 'date', e.target.value)}
                  />
                  )}

                  {['category', 'description', 'itemName', 'specification', 'unit', 'taxRate', 'invoiceNumber',
                  'buyerName', 'sellerName', 'remarks'].includes(col.id) && (
                  <input type="text" className="input-modern px-3 py-1.5 rounded text-sm w-full" value={item[col.id]}
                    onChange={e=> updateItem(item.id, col.id, e.target.value)}
                  />
                  )}

                  {['amount', 'quantity', 'unitPrice', 'subtotal', 'totalWithTax', 'tax'].includes(col.id) && (
                  <input type="number" step="0.01"
                    className="input-modern px-3 py-1.5 rounded text-sm w-full text-right" value={item[col.id]}
                    onChange={e=> updateItem(item.id, col.id, parseFloat(e.target.value) || 0)}
                  />
                  )}

                  {col.id === 'actions' && (
                  <div className="flex gap-2">
                    <button onClick={()=> toggleRow(item.id)}
                      className="p-1.5 hover:bg-[#2a2a2a] rounded"
                      title="å±•å¼€è¯¦æƒ…"
                      >
                      {expandedRows.has(item.id) ?
                      <ChevronUp size={16} /> :
                      <ChevronDown size={16} />}
                    </button>
                    <button onClick={()=> deleteItem(item.id)}
                      className="p-1.5 hover:bg-red-500/10 text-red-400 rounded"
                      title="åˆ é™¤"
                      >
                      <X size={16} />
                    </button>
                  </div>
                  )}
                </td>
                ))}
              </tr>
              {
              expandedRows.has(item.id) && (
              <tr>
                <td colSpan={columns.filter(c=> c.visible).length} className="bg-[#0f0f0f]">
                  <div className="p-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    {/* Render all fields in expanded view for completeness, or just the ones not in main table?
                    For simplicity, render the inputs again or just the common ones.
                    Let's render the detailed ones. */}
                    <div className="md:col-span-3 pb-2 border-b border-[#2a2a2a] mb-2 font-cn text-xs text-gray-400">
                      è¯¦ç»†ä¿¡æ¯
                    </div>
                    {['invoiceNumber', 'buyerName', 'sellerName', 'itemName', 'specification', 'unit', 'quantity',
                    'unitPrice', 'taxRate', 'tax', 'remarks'].map(field => {
                    const label = (initialColumns.find(c => c.id === field) || {}).label || field;
                    return (
                    <div key={field}>
                      <label className="text-xs text-gray-500 mb-1 block font-cn">{label}</label>
                      {field === 'remarks' ? (
                      <textarea className="input-modern px-3 py-2 rounded text-sm w-full resize-none" rows="2"
                        value={item[field]} onChange={e=> updateItem(item.id, field, e.target.value)}
                                            />
                                          ) : (
                                            <input
                                              type={['quantity', 'unitPrice', 'tax', 'amount'].includes(field) ? "number" : "text"}
                                              className="input-modern px-3 py-1.5 rounded text-sm w-full"
                                              value={item[field]}
                                              onChange={e => updateItem(item.id, field, (['quantity', 'unitPrice', 'tax'].includes(field) ? parseFloat(e.target.value) || 0 : e.target.value))}
                                            />
                                          )}
                                        </div>
                                      );
                                    })}
                                  </div>
                                </td>
                              </tr>
                            )
                          }
                        </React.Fragment>
                      ))}
                    </tbody>
                  </table>
                </div>

                {/* Summary & Actions */}
                <div className="p-6 border-t border-[#2a2a2a] bg-[#0f0f0f]">
                  <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div className="text-sm">
                      <span className="text-gray-500 font-cn">æ€»è®¡ï¼š</span>
                      {/* Use proper calculation for display total */}
                      <span className="text-2xl font-bold text-yellow-400 ml-2 font-en">Â¥{items.reduce((sum, item) => sum + Number(item.amount || 0), 0).toFixed(2)}</span>
                    </div>
                    <div className="flex gap-3">
                      <button
                        onClick={() => setShowColumnManager(true)}
                        className="px-5 py-2.5 bg-[#1a1a1a] hover:bg-[#2a2a2a] border border-[#2a2a2a] rounded-lg text-sm flex items-center gap-2 transition"
                      >
                        <Settings size={16} />
                        <span className="font-cn">åˆ—è®¾ç½®</span>
                      </button>
                      <button
                        onClick={addNewRow}
                        className="px-5 py-2.5 bg-[#1a1a1a] hover:bg-[#2a2a2a] border border-[#2a2a2a] rounded-lg text-sm flex items-center gap-2 transition"
                      >
                        <Plus size={16} />
                        <span className="font-cn">æ·»åŠ æ–°è¡Œ</span>
                      </button>
                      <button
                        onClick={() => setShowExportPreview(true)}
                        className="px-5 py-2.5 bg-[#F5D158] hover:bg-[#e5c148] text-black border border-[#F5D158] rounded-lg text-sm flex items-center gap-2 transition font-medium"
                      >
                        <Eye size={16} />
                        <span className="font-cn">å¯¼å‡ºé¢„è§ˆ</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )
            }

            {/* Column Manager Modal */}
            {
              showColumnManager && (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6" onClick={() => setShowColumnManager(false)}>
                  <div className="bg-[#141414] rounded-xl border border-[#2a2a2a] p-6 w-full max-w-lg" onClick={e => e.stopPropagation()}>
                    <div className="flex justify-between items-center mb-6">
                      <h3 className="text-lg font-bold font-cn">åˆ—æ˜¾ç¤ºä¸æ’åº</h3>
                      <button onClick={() => setShowColumnManager(false)}><X size={20} /></button>
                    </div>
                    <div className="space-y-2 max-h-[60vh] overflow-y-auto">
                      {columns.filter(c => !c.fixed).map((col, index) => (
                        <div key={col.id} className="flex items-center justify-between p-3 bg-[#1a1a1a] rounded-lg">
                          <div className="flex items-center gap-3">
                            <input
                              type="checkbox"
                              checked={col.visible}
                              onChange={() => {
                                const newCols = columns.map(c => c.id === col.id ? { ...c, visible: !c.visible } : c);
                                setColumns(newCols);
                              }}
                              className="w-4 h-4 rounded bg-[#0a0a0a] border-[#2a2a2a]"
                            />
                            <span className="font-cn">{col.label}</span>
                          </div>
                          <div className="flex gap-1">
                            <button
                              className="p-1 hover:bg-[#2a2a2a] rounded disabled:opacity-30"
                              disabled={index === 0}
                              onClick={() => {
                                // Move up (logic needs to handle the fixed preview col at index 0 in the full array)
                                // Quick hack: Swap in the full array.
                                const fullIndex = columns.findIndex(c => c.id === col.id);
                                if (fullIndex <= 1) return; // Cant move above preview

                                const newCols = [...columns];
                                [newCols[fullIndex], newCols[fullIndex - 1]] = [newCols[fullIndex - 1], newCols[fullIndex]];
                                setColumns(newCols);
                              }}
                            >
                              <ChevronUp size={16} />
                            </button>
                            <button
                              className="p-1 hover:bg-[#2a2a2a] rounded disabled:opacity-30"
                              disabled={index === columns.filter(c => !c.fixed).length - 1}
                              onClick={() => {
                                // Move down
                                const fullIndex = columns.findIndex(c => c.id === col.id);
                                if (fullIndex >= columns.length - 2) return; // Cant move below actions

                                const newCols = [...columns];
                                [newCols[fullIndex], newCols[fullIndex + 1]] = [newCols[fullIndex + 1], newCols[fullIndex]];
                                setColumns(newCols);
                              }}
                            >
                              <ChevronDown size={16} />
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                    <div className="mt-6 flex justify-end">
                      <button onClick={() => setShowColumnManager(false)} className="btn-primary px-6 py-2 rounded-lg text-sm font-cn">å®Œæˆ</button>
                    </div>
                  </div>
                </div>
              )
            }

            {/* Export Preview Modal */}
            {
              showExportPreview && (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6" onClick={() => setShowExportPreview(false)}>
                  <div className="bg-[#141414] rounded-xl border border-[#2a2a2a] p-6 w-full max-w-5xl max-h-[85vh] overflow-auto" onClick={e => e.stopPropagation()}>
                    <div className="flex justify-between items-center mb-6">
                      <h3 className="text-lg font-bold font-cn">å¯¼å‡ºé¢„è§ˆ</h3>
                      <button onClick={() => setShowExportPreview(false)}><X size={20} /></button>
                    </div>

                    {/* Column Toggle for Export */}
                    <div className="mb-4 p-4 bg-[#1a1a1a]/50 rounded-lg border border-[#2a2a2a]">
                      <h4 className="text-sm font-bold font-cn mb-2 text-gray-400">é€‰æ‹©è¦åœ¨é¢„è§ˆ/å¯¼å‡ºä¸­åŒ…å«çš„åˆ—ï¼š</h4>
                      <div className="flex flex-wrap gap-2">
                        {columns.filter(c => c.id !== 'actions').map(col => (
                          <label key={col.id} className="flex items-center gap-2 text-xs font-cn bg-[#0a0a0a] px-2 py-1 rounded cursor-pointer border border-[#2a2a2a] hover:border-[#F5D158] transition select-none">
                            <input
                              type="checkbox"
                              checked={col.visible}
                              onChange={() => {
                                const newCols = columns.map(c => c.id === col.id ? { ...c, visible: !c.visible } : c);
                                setColumns(newCols);
                              }}
                              disabled={col.id === 'amount'}
                              className="rounded bg-black border-[#2a2a2a]"
                            />
                            {col.label}
                          </label>
                        ))}
                      </div>
                    </div>

                    {/* Tab Navigation */}
                    <div className="flex gap-2 mb-6 border-b border-[#2a2a2a]">
                      <button
                        onClick={() => setPreviewTab('excel')}
                        className={`px-4 py-2 font-cn text-sm transition-colors ${previewTab === 'excel'
                          ? 'text-[#F5D158] border-b-2 border-[#F5D158]'
                          : 'text-gray-400 hover:text-white'
                          }`}
                      >
                        Excel é¢„è§ˆ
                      </button>
                      <button
                        onClick={() => setPreviewTab('pdf')}
                        className={`px-4 py-2 font-cn text-sm transition-colors ${previewTab === 'pdf'
                          ? 'text-[#F5D158] border-b-2 border-[#F5D158]'
                          : 'text-gray-400 hover:text-white'
                          }`}
                      >
                        PDF é¢„è§ˆ
                      </button>
                    </div>

                    {/* Tab Content */}
                    {previewTab === 'excel' ? (
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead>
                            <tr className="border-b border-[#2a2a2a]">
                              {columns.filter(c => c.visible && c.id !== 'preview' && c.id !== 'actions').map(col => (
                                <th key={col.id} className="p-2 text-left font-cn">{col.label}</th>
                              ))}
                            </tr>
                          </thead>
                          <tbody>
                            {items.map(item => (
                              <tr key={item.id} className="border-b border-[#2a2a2a]/50">
                                {columns.filter(c => c.visible && c.id !== 'preview' && c.id !== 'actions').map(col => (
                                  <td key={col.id} className="p-2">
                                    {['amount', 'subtotal', 'totalWithTax', 'tax', 'unitPrice'].includes(col.id)
                                      ? `Â¥${Number(item[col.id] || 0).toFixed(2)}`
                                      : item[col.id] || ''}
                                  </td>
                                ))}
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    ) : (
                      <div className="overflow-auto max-h-[600px] bg-white/5 rounded-lg p-4">
                        {/* PDF Preview - Reference to the same content used for export */}
                        <PDFContent items={items} reimbursementInfo={reimbursementInfo} columns={columns} />
                      </div>
                    )}

                    <div className="mt-6 flex justify-end gap-3">
                      <button onClick={() => setShowExportPreview(false)} className="px-4 py-2 bg-[#1a1a1a] hover:bg-[#2a2a2a] rounded-lg text-sm font-cn">å…³é—­</button>
                      <button onClick={() => { setShowExportPreview(false); exportExcel(); }} className="btn-primary px-4 py-2 rounded-lg text-sm font-cn">å¯¼å‡º Excel</button>
                      <button onClick={() => { setShowExportPreview(false); exportPDF_Print(); }} className="btn-primary px-4 py-2 rounded-lg text-sm font-cn">å¯¼å‡º PDF</button>
                    </div>
                  </div>
                </div>
              )
            }


            {
              items.length === 0 && !isProcessing && (
                <div className="text-center py-20 text-gray-600">
                  <Upload size={48} className="mx-auto mb-4 opacity-30" />
                  <p className="font-cn mb-3 text-gray-600">
                    æš‚æ— æ•°æ®ï¼Œè¯·ä¸Šä¼ å‘ç¥¨å¼€å§‹
                  </p>
                  <div className="flex items-center justify-center gap-2 text-sm">
                    <span>æˆ–</span>
                    <button
                      onClick={() => {
                        setItems([{
                          id: Date.now(),
                          date: new Date().toISOString().split('T')[0],
                          category: '',
                          description: '',
                          itemName: '',
                          specification: '',
                          quantity: 1,
                          unit: '',
                          unitPrice: 0,
                          amount: 0,
                          invoiceNumber: '',
                          buyerName: '',
                          sellerName: '',
                          remarks: '',
                          previewUrl: null,
                          orderImage: null,
                          paymentProof: null,
                          taxRate: '',
                          tax: 0,
                          subtotal: 0,
                          totalWithTax: 0,
                          isPDF: false,
                          file: null
                        }]);
                      }}
                      className="px-4 py-2 bg-[#2a2a2a] hover:bg-[#3a3a3a] text-gray-300 rounded-lg transition font-cn"
                    >
                      æ·»åŠ é»˜è®¤ç©ºç™½è¡Œ
                    </button>
                  </div>
                </div>
              )
            }

            {/* Footer */}
            <footer className="mt-8 pb-6 text-center text-xs text-gray-600">
              <button
                onClick={() => setShowTutorial(true)}
                className="text-gray-500 hover:text-gray-400 transition mb-3 block mx-auto font-cn"
              >
                æŸ¥çœ‹æ•™ç¨‹
              </button>
              <div className="flex items-center justify-center gap-2 mb-1">
                <span>Version 1.0</span>
                <span>â€¢</span>
                <span>Â© Kairos Studio 2026</span>
              </div>
              <p className="text-gray-700 mt-1">Powered by Qwen</p>
            </footer>

          </main >

          {/* PDF Preview Modal */}
          {
            pdfPreviewUrl && (
              <div
                className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-6"
                onClick={() => setPdfPreviewUrl(null)}
              >
                <div className="relative w-full max-w-4xl max-h-[90vh] bg-[#141414] rounded-xl overflow-hidden">
                  <div className="flex justify-between items-center p-4 border-b border-[#2a2a2a]">
                    <span className="font-semibold font-cn">PDF é¢„è§ˆ</span>
                    <button onClick={() => setPdfPreviewUrl(null)} className="p-2 hover:bg-[#2a2a2a] rounded">
                      <X size={20} />
                    </button>
                  </div>
                  <embed src={pdfPreviewUrl} type="application/pdf" className="w-full h-[80vh]" />
                </div>
              </div>
            )
          }
        </div >
      );
    }; // Close App component

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

    lucide.createIcons();
  </script>
</body>

</html>