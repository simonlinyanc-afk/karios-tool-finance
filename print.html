<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ¥é”€å•æ‰“å°</title>
    <style>
        /* å…¨å±€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* é¡µé¢è®¾ç½® */
        @page {
            size: A4 landscape;
            margin: 10mm;
        }

        body {
            font-family: 'Noto Sans SC', 'Microsoft YaHei', sans-serif;
            font-size: 9px;
            line-height: 1.4;
            color: #000;
            background: #fff;
        }

        /* å®¹å™¨ */
        .container {
            width: 277mm;
            /* A4 landscape - 20mm margins */
            margin: 0 auto;
            padding: 5mm;
        }

        /* é¡¶éƒ¨æç¤ºï¼ˆä»…å±å¹•æ˜¾ç¤ºï¼‰ */
        .print-notice {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            padding: 12px;
            margin-bottom: 16px;
            border-radius: 4px;
            text-align: center;
        }

        .print-notice h2 {
            font-size: 16px;
            margin-bottom: 8px;
            color: #92400e;
        }

        .print-notice p {
            font-size: 12px;
            color: #78350f;
        }

        /* æŠ¥é”€å•å¤´éƒ¨ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .header img {
            height: 32px;
        }

        .header h1 {
            flex: 1;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }

        /* ä¿¡æ¯ç½‘æ ¼ */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 6px;
            font-size: 10px;
        }

        .payment-info {
            margin-bottom: 6px;
            font-size: 10px;
        }

        /* è¡¨æ ¼ */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 8px;
        }

        th,
        td {
            border: 1px solid #999;
            padding: 4px;
            text-align: left;
            vertical-align: middle;
        }

        th {
            background: #f0f0f0;
            font-weight: bold;
        }

        td img {
            width: 64px;
            height: 64px;
            object-fit: contain;
            display: block;
            margin: 0 auto;
        }

        tfoot td {
            background: #f9f9f9;
            font-weight: bold;
            text-align: right;
        }

        /* å¤‡æ³¨ */
        .notes {
            margin-top: 16px;
            font-size: 11px;
        }

        .notes p:last-child {
            min-height: 30px;
            border-bottom: 1px solid #ccc;
        }

        /* ç­¾å­— */
        .signatures {
            display: flex;
            justify-content: space-between;
            margin-top: 24px;
            font-size: 11px;
        }

        .signatures span {
            display: inline-block;
            min-width: 100px;
            border-bottom: 1px solid #ccc;
        }

        /* æ‰“å°æ—¶éšè—æç¤º */
        @media print {
            .print-notice {
                display: none;
            }

            .container {
                width: 100%;
                padding: 0;
            }

            @page {
                margin: 10mm;
            }
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 14px;
            color: #666;
        }

        .error {
            background: #fee;
            border: 2px solid #f00;
            padding: 20px;
            margin: 20px;
            border-radius: 4px;
            text-align: center;
        }
    </style>
</head>

<body>
    <!-- åŠ è½½æç¤º -->
    <div id="loading" class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>

    <!-- é”™è¯¯æç¤º -->
    <div id="error" class="error" style="display: none;">
        <h2>åŠ è½½å¤±è´¥</h2>
        <p id="error-message"></p>
    </div>

    <!-- æ‰“å°å†…å®¹ -->
    <div id="content" style="display: none;">
        <!-- å±å¹•æç¤º -->
        <div class="print-notice">
            <h2>ğŸ“„ æ‰“å°é¢„è§ˆ</h2>
            <p>è¯·ä½¿ç”¨ <strong>Ctrl+P (Windows)</strong> æˆ– <strong>Cmd+P (Mac)</strong> æ‰“å°</p>
            <p>åœ¨æ‰“å°å¯¹è¯æ¡†ä¸­é€‰æ‹© <strong>"å¦å­˜ä¸ºPDF"</strong> å³å¯ä¿å­˜</p>
        </div>

        <!-- æŠ¥é”€å•å†…å®¹ -->
        <div class="container">
            <div class="header">
                <img src="assets/logo_text.png" alt="Kairos Logo" />
                <h1>æŠ¥é”€å•</h1>
                <img src="assets/logo_graph.png" alt="Kairos Graph" />
            </div>

            <div class="info-grid">
                <p><strong>æŠ¥é”€äºº:</strong> <span id="reimburser"></span></p>
                <p><strong>æ‰€å±é¡¹ç›®:</strong> <span id="project"></span></p>
                <p><strong>æŠ¥é”€æ—¥æœŸ:</strong> <span id="date"></span></p>
            </div>

            <div class="payment-info">
                <p><strong>æ”¶æ¬¾ä¿¡æ¯:</strong> <span id="payment-info"></span></p>
            </div>

            <table>
                <thead id="table-header">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </thead>
                <tbody id="table-body">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </tbody>
                <tfoot id="table-footer">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </tfoot>
            </table>

            <div class="notes">
                <p><strong>å¤‡æ³¨:</strong></p>
                <p></p>
            </div>

            <div class="signatures">
                <p><strong>æŠ¥é”€äººç­¾å­—:</strong> <span></span></p>
                <p><strong>å®¡æ ¸äººç­¾å­—:</strong> <span></span></p>
            </div>
        </div>
    </div>

    <!-- Dexie for IndexedDB -->
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script>
        // Init Database (Read-only access pattern mostly, but need schema to match)
        const db = new Dexie('KairosDB');
        db.version(1).stores({ drafts: '++id, timestamp', history: '++id, timestamp, total, count' });
        db.version(2).stores({ history: '++id, timestamp, total, count, fileHashIndex' });
        db.version(3).stores({ templates: '++id, timestamp, name' });
        db.version(4).stores({ printJobs: '++id, timestamp' }); // Match current schema

        // ä» URL è·å– jobId
        function getJobId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('jobId') ? Number(params.get('jobId')) : null;
        }

        // åŠ è½½æ•°æ®
        async function loadPrintData() {
            try {
                const jobId = getJobId();

                if (jobId) {
                    // Try Dexie First (IndexedDB)
                    console.log('Loading print job from DB:', jobId);
                    const record = await db.printJobs.get(jobId);
                    if (record && record.data) {
                        return record.data;
                    }
                }

                // Fallback to LocalStorage
                console.log('Loading print job from LocalStorage');
                const dataStr = localStorage.getItem('printData');
                if (!dataStr) {
                    throw new Error('æœªæ‰¾åˆ°æ‰“å°æ•°æ®ã€‚è¯·ä»ä¸»é¡µé¢é‡æ–°å¯¼å‡ºã€‚');
                }
                const data = JSON.parse(dataStr);

                // éªŒè¯æ•°æ®
                if (!data.items || !data.reimbursementInfo || !data.columns) {
                    throw new Error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                }
                return data;
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                throw error;
            }
        }

        // æ¸²æŸ“é¡µé¢
        function renderPage(data) {
            const { items, reimbursementInfo, columns } = data;

            // å¡«å……åŸºæœ¬ä¿¡æ¯
            document.getElementById('reimburser').textContent = reimbursementInfo.reimburser || 'æœªå¡«å†™';
            document.getElementById('project').textContent = reimbursementInfo.project || 'æœªå¡«å†™';
            document.getElementById('date').textContent = reimbursementInfo.reimbursementDate || new Date().toLocaleDateString('zh-CN');
            document.getElementById('payment-info').textContent = reimbursementInfo.paymentInfo || 'æœªå¡«å†™';

            // æ¸²æŸ“è¡¨å¤´
            const thead = document.getElementById('table-header');
            const headerRow = document.createElement('tr');
            columns.forEach(col => {
                const th = document.createElement('th');
                th.textContent = col.label;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            // æ¸²æŸ“è¡¨ä½“
            const tbody = document.getElementById('table-body');
            items.forEach(item => {
                const row = document.createElement('tr');

                columns.forEach(col => {
                    const td = document.createElement('td');

                    // å›¾ç‰‡åˆ—
                    if (col.id === 'preview' || col.id === 'orderImage' || col.id === 'paymentProof') {
                        let content;

                        // Prefer the raw Blob (File) from IndexedDB if available
                        if (col.id === 'preview') content = item.file || item.previewUrl;
                        else if (col.id === 'orderImage') content = item.orderImageFile || item.orderImage;
                        else if (col.id === 'paymentProof') content = item.paymentProofFile || item.paymentProof;

                        // Create fresh Object URL from Blob
                        if (content instanceof Blob) {
                            content = URL.createObjectURL(content);
                        }

                        if (content && typeof content === 'string') {
                            const img = document.createElement('img');
                            img.src = content;
                            img.alt = col.label;
                            td.appendChild(img);
                        }
                    }
                    // é‡‘é¢åˆ—
                    else if (['amount', 'subtotal', 'totalWithTax', 'tax', 'unitPrice'].includes(col.id)) {
                        td.textContent = 'Â¥' + Number(item[col.id] || 0).toFixed(2);
                    }
                    // æ™®é€šåˆ—
                    else {
                        td.textContent = item[col.id] || '';
                    }

                    row.appendChild(td);
                });

                tbody.appendChild(row);
            });

            // è®¡ç®—æ€»è®¡
            const totalAmount = items.reduce((sum, item) => sum + Number(item.amount || 0), 0);

            // æ¸²æŸ“è¡¨å°¾
            const tfoot = document.getElementById('table-footer');
            const footerRow = document.createElement('tr');
            const totalLabelCell = document.createElement('td');
            totalLabelCell.colSpan = columns.length - 1;
            totalLabelCell.textContent = 'æ€»è®¡:';
            footerRow.appendChild(totalLabelCell);

            const totalValueCell = document.createElement('td');
            totalValueCell.textContent = 'Â¥' + totalAmount.toFixed(2);
            footerRow.appendChild(totalValueCell);

            tfoot.appendChild(footerRow);
        }

        // åˆå§‹åŒ–
        window.addEventListener('load', async function () {
            try {
                // è¯»å–æ•°æ®
                const data = await loadPrintData();

                // æ¸²æŸ“é¡µé¢
                renderPage(data);

                // éšè—åŠ è½½æç¤º
                document.getElementById('loading').style.display = 'none';

                // æ˜¾ç¤ºå†…å®¹
                document.getElementById('content').style.display = 'block';

                // å»¶è¿Ÿè§¦å‘æ‰“å°ï¼ˆç¡®ä¿å›¾ç‰‡åŠ è½½ï¼‰
                setTimeout(function () {
                    window.print();
                }, 800);

            } catch (error) {
                // æ˜¾ç¤ºé”™è¯¯
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error-message').textContent = error.message;
            }
        });
    </script>
</body>

</html>